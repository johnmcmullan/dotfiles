Warning: Failed to connect to Confluence: Unauthorized (401)
# TBRICKS APP REGRESSION ANALYSIS CHECKLIST

## REGRESSION ANALYSIS INSTRUCTIONS
**Analyze code changes against this checklist. Flag any modifications that could violate these requirements.**

**CRITICAL: You must provide EVIDENCE for each finding - show actual code snippets, method names, file paths, and line numbers. Generic statements without code evidence will be rejected.**

**METADATA ANALYSIS REQUIREMENT: Distinguish between actions already completed (evidenced by updated files in the commit) versus actions still required. Do not flag completed actions as "required".**

## 1. BASIC REGRESSION CHECKS

### Critical Path Performance
- [ ] **No new synchronous resolves on critical path**
  ```cpp
  // FLAG THIS WITH FILE/LINE: 
  Instrument inst = Instrument::Resolve(id);  // Blocks in callback
  
  // EVIDENCE REQUIRED:
  // - Which callback contains the synchronous resolve?
  // - What method calls Instrument::Resolve()?
  // - Is this in HandleBestPrice(), HandleRunRequest(), etc.?
  ```

### Stream Snapshot Dependencies  
- [ ] **All stream snapshots received before app acts**
  ```cpp
  // EVIDENCE REQUIRED:
  // - Which streams are opened in constructor?
  // - Where are orders/quotes sent?
  // - Is HandleSnapshotEnd() checking ALL required streams?
  
  // CHECK PATTERN:
  if (!m_instrumentStream.IsSnapshotDone() || !m_bestPriceStream.IsSnapshotDone()) {
      return; // Don't send orders yet
  }
  SendOrder(orderOptions);  // This line needs stream dependency check
  ```

### Floating Point Comparisons
- [ ] **Epsilon-comparison used for floating point** (shared/Comparators.h)
  ```cpp
  // FLAG WITH EVIDENCE:
  if (price1 == price2) { }              // File: MyApp.cpp:142
  if (volume.GetVolume() == 0.0) { }     // File: MyApp.cpp:67
  
  // MUST SHOW REPLACEMENT:
  if (tbricks::IsEqual(price1, price2)) { }
  if (tbricks::IsZero(volume.GetVolume())) { }
  ```

### Stream Field Optimization
- [ ] **Stream subscribe fields restricted to required only**
  ```cpp
  // CHECK: Are unnecessary fields being subscribed?
  BestPriceStream::SetSubscribedFields(
      BestPriceStream::Fields::BidPrice() || 
      BestPriceStream::Fields::AskPrice()
  );
  ```

### Exception Safety
- [ ] **No uncaught exceptions from app code**
  - Check new code paths for proper try/catch
  - Verify third-party library calls are wrapped

## 2. BUILD REGRESSION CHECKS

### Dependencies
- [ ] **All code paths added to GNUmakefile**
  - New source files included
  - Library dependencies added
  - App dependencies declared

### Compilation Warnings
- [ ] **No warnings in debug and perf profiles**
  - Check both build configurations
  - Deprecation warnings acceptable if tracked for later fix

## 3. LOGGING REGRESSION CHECKS

### Log Level Appropriateness
- [ ] **Error logs only for critical errors**
  ```cpp
  // CORRECT usage:
  TBERROR("Stream failed permanently");
  
  // WRONG - not critical:
  TBERROR("Parameter validation failed");
  ```

- [ ] **Warning logs for user-actionable issues**
  ```cpp
  // CORRECT:
  TBWARNING("Market data became stale");
  
  // WRONG - not actionable:
  TBWARNING("Received update");
  ```

### Performance Impact
- [ ] **High priority logs not excessive**
- [ ] **High priority logs outside critical path**

### Debug Cleanup
- [ ] **No testing/debugging logs remain**
  ```cpp
  // FLAG THESE WITH FILE/LINE EVIDENCE:
  TBNOTICE("1234567");                    // File: MyApp.cpp:89
  TBNOTICE("DEBUG: entering function");   // File: MyApp.cpp:156
  TBDEBUG("test message");               // File: MyApp.cpp:203
  
  // EVIDENCE REQUIRED:
  // - Search entire app for test strings
  // - Check all TBNOTICE/TBDEBUG for non-production messages
  // - Verify no hardcoded test values in log outputs
  ```

## 4. METADATA REGRESSION CHECKS

### Export Requirements
- [ ] **Metadata exported after app designer changes**
  - Panel modifications
  - Parameter changes
  - Related parameters/columns

### Definition Generation  
- [ ] **tbricks_definitions.h generated after changes to:**
  - App parameters/related parameters
  - Related apps/rankings
  - Tree types
  - Enumerations

### Metadata Quality
- [ ] **No custom properties in app metadata**
- [ ] **No unwanted objects in exported metadata**
- [ ] **SDK shared metadata exported if changed**
- [ ] **No parameter persistence unless required**

## 5. OBJECT MANAGEMENT REGRESSION CHECKS

### Cleanup on State Changes
- [ ] **No active orders/quotes after pause/delete**
  ```cpp
  // EVIDENCE REQUIRED - SHOW ACTUAL METHOD IMPLEMENTATION:
  void MyApp::HandlePauseRequest() {
      // Must show: How are orders canceled?
      // Must show: What cleanup code exists?
      // Must show: Are all child objects handled?
      
      CancelAllOrders();  // File: MyApp.cpp:234 - verify this exists
      SetState(StrategyState::PAUSED);
  }
  
  // CHECK THESE PATTERNS:
  // - Is Order::SendCancelRequest() called for each active order?
  // - Are Quote::SendDeleteRequest() calls present?
  // - Are child strategy deletion calls present?
  ```

- [ ] **No running child strategies after parent pause/delete**
  ```cpp
  // MUST PROVIDE EVIDENCE OF CHILD MANAGEMENT:
  void MyApp::HandleDeleteRequest() {
      for (const auto& childId : m_childStrategies) {    // File: MyApp.cpp:267
          Strategy::SendDeleteRequest(childId, *this);   // Verify this call exists
      }
      m_childStrategies.clear();  // Verify cleanup
      SetState(StrategyState::DELETED);
  }
  
  // EVIDENCE REQUIRED:
  // - Where are child strategy IDs stored? (member variable name)
  // - How are children tracked during creation?
  // - Is cleanup called in both pause AND delete handlers?
  ```

### Data Propagation
- [ ] **Extra data passed on object creation/modification**
  - Strategy attributes
  - Forward parameters  
  - Regulatory parameters

## 6. PARAMETER REGRESSION CHECKS

### Startup Validation
- [ ] **App can start with constructor parameters**
- [ ] **App doesn't run without mandatory parameters**
- [ ] **App rejects invalid parameter values**
  ```cpp
  // CHECK: Validation in constructor and HandleValidateRequest
  if (m_volume.GetVolume() <= 0.0) {
      // Handle invalid volume
  }
  ```

### UI Consistency
- [ ] **Panel validation disables irrelevant controls**
- [ ] **Validation logic matches modification handling**
  ```cpp
  // CHECK: Same logic in both places
  void HandleValidateRequest(ValidationContext& context) { }
  void HandleModifyRequest(StrategyModifier& modifier) { }
  ```

### Trading Information Integration
- [ ] **Price/Volume parameters use InstrumentTradingInformation**
- [ ] **Strategy attributes applied on creation/modification**

## 7. RECOVERY REGRESSION CHECKS

### State Management
- [ ] **App not running if recovered in Paused state** (unless STRATEGY_RUN pending)
  ```cpp
  // CHECK: Recovery logic in constructor
  if (reason.IsRecovered() && GetState().IsPaused() && 
      !GetTransactionOperation().IsRun()) {
      // Should remain paused
  }
  ```

### Order Recovery
- [ ] **No orders sent until order recovery complete**
- [ ] **Child strategies collected before creating new ones**

## 8. STATE REGRESSION CHECKS

### State Transitions
- [ ] **Correct state transitions maintained**
  ```cpp
  // CHECK: Valid transitions only
  SetState(StrategyState::RUNNING);   // From PAUSED
  SetState(StrategyState::DELETED);   // From any state
  ```

### Resource Management
- [ ] **App deletes when panel closed** (if not background app)
- [ ] **No resources consumed in Paused state**
  ```cpp
  // CHECK: Streams closed, timers stopped when paused
  void HandlePauseRequest() {
      m_timer.Stop();
      m_dataStream.Close();
  }
  ```

- [ ] **No object management in Paused state**

## 9. THREADING MODEL AWARENESS

### Single-Threaded Compliance (Secondary Check)
- [ ] **No static variables introduced**
- [ ] **No manual threading primitives added**  
- [ ] **EventProcessor used for cross-thread calls**
- [ ] **Apps remain re-entrant**

## EVIDENCE REQUIREMENTS:

### ALL FINDINGS MUST INCLUDE:
- **File path and line numbers** where issue occurs
- **Actual code snippets** showing the problem
- **Method names and class names** involved
- **Specific parameter names** and types affected
- **Before/after code comparisons** for changes

### CODE EXAMPLES MUST:
- Use actual Tbricks SDK method names (HandleRunRequest, SetState, etc.)
- Show complete method signatures and parameter types
- Include actual variable names and member variables
- Demonstrate specific Tbricks patterns (streams, parameters, lifecycle)

## REGRESSION ANALYSIS OUTPUT FORMAT:

```
## Regression Analysis Results

### Critical Issues (Block Commit):
**Issue:** [Specific violation with evidence]
**File:** [path/to/file.cpp:line_number]
**Code:**
```cpp
// Show actual problematic code
```
**Impact:** [How this breaks Tbricks requirements]
**Fix Required:** [Specific code changes needed]

### Medium Issues (Address Before Release):  
**Issue:** [Specific violation with evidence]
**File:** [path/to/file.cpp:line_number]
**Code:**
```cpp
// Show actual problematic code
```
**Impact:** [Potential problems this could cause]
**Recommendation:** [Specific improvements needed]

### Minor Issues (Technical Debt):
**Issue:** [Specific violation with evidence]
**File:** [path/to/file.cpp:line_number]
**Code:**
```cpp
// Show actual code pattern
```
**Suggestion:** [Best practice improvement]

### Metadata Status Assessment:
✅ **COMPLETED ACTIONS:**
- App metadata export: [Evidence from .xml file changes if present]
- tbricks_definitions.h generation: [Evidence from tbricks_definitions.h file changes showing new parameters]
- SDK shared metadata export: [Evidence from shared .xml changes - if present]

❌ **REQUIRED ACTIONS:**  
- [Only list if changes demand metadata updates but parameters are not in tbricks_definitions.h]

⚠️ **VERIFICATION NEEDED:**
- [List if metadata changes are present but need validation]

### Evidence Summary:
- **Files analyzed:** [count] 
- **Methods reviewed:** [list key methods examined]
- **Parameters checked:** [list parameter types reviewed]
- **Streams verified:** [list stream types checked]

### Recommendations:
[Specific, actionable changes with file paths and method names]
```

## QUALITY VERIFICATION CHECKLIST:
- [ ] Every issue includes actual code evidence
- [ ] File paths and line numbers provided for all findings
- [ ] Actual Tbricks method names used (not generic descriptions)
- [ ] Parameter types and stream patterns specifically identified
- [ ] Before/after comparisons shown for modifications
- [ ] Specific technical recommendations provided

## COMMIT DECISION:
- **BLOCK**: Any critical issues present with evidence
- **CONDITIONAL**: Medium issues documented with specific remediation plan
- **APPROVE**: Only minor issues or analysis shows compliance

**If you cannot provide specific code evidence for findings or lack access to sufficient technical details, write:**
"INSUFFICIENT INFORMATION - Cannot provide code-level evidence for regression analysis. Need access to: [list specific files, methods, or technical details required]"

## FINAL VERIFICATION REQUIREMENTS:

### BEFORE SUBMITTING ANALYSIS, VERIFY:
- [ ] **Every flagged issue includes actual code snippet** (not pseudocode)
- [ ] **File paths and line numbers provided** for all violations
- [ ] **Actual Tbricks method names used** (HandleRunRequest, SetState, SendModifyRequest, etc.)
- [ ] **Specific parameter types identified** (VolumeParameter, PriceParameter, etc.)
- [ ] **Stream types and patterns verified** (BestPriceStream, InstrumentStream, etc.)
- [ ] **Member variable names shown** (m_volume, m_instrumentStream, etc.)
- [ ] **Complete method signatures provided** for modified/new methods
- [ ] **Metadata changes specifically identified** (which parameters, enums, apps)

### ANALYSIS MUST DEMONSTRATE:
- **Code-level understanding**: Shows actual implementation details
- **Tbricks expertise**: Uses correct SDK terminology and patterns  
- **Regression focus**: Identifies what changed and why it matters
- **Actionable findings**: Provides specific fix instructions with code

### REJECT ANALYSIS IF:
- Generic statements without code evidence
- Missing file paths or method names
- Vague descriptions instead of specific technical findings
- No concrete recommendations for fixes
- Failure to identify specific Tbricks patterns affected
# Case Analysis Request
## Case Information
- Case Number: APP-47817
- Total number of related commits: 3
- Information: Git diffs are prefixed - for lines removed and + for lines added

## JIRA Cases Information

[APP-38660] Order minion: Support minion parameter validation for app view model updates Created: 2022-10-27  Updated: 2025-11-05  Resolved: 2022-11-10
Status:	Closed
Project:	APP
Component/s:	Order minion
Affects Version/s:	Tbricks 2.20
Fix Version/s:	Tbricks 2.21

Type:	Improvement	Priority:	Major
Reporter:	Joakim Gerth	Assignee:	Joakim Gerth
Resolution:	Fixed

Issue Links:
Dependency
is blocked by	TB-121687	VE: Unconfirmed values not applied for app view model if direction is output	Closed
blocks	APP-37173	MM: Add Desk panel	Closed
blocks	APP-36422	QM: Set valid values order minion parameters in all grids	Verified
Regression
makes regression	APP-47219	SQ: Slow hedging/+Order creation	Closed
Relation
is related to	TB-92023	Enable relative offsets in numeric input	Verified

Comments
Comment by Joakim Gerth [ 2022-10-27 ]
{noformat}
24a5600 2022-10-27  APP-38660: Prepare minion parameters for use with app view model updates 
88af93a 2022-10-27  APP-38660: Support validation for app view model updates{noformat}
Comment by Joakim Gerth [ 2022-10-27 ]
The changes in this case will not work 100 % until TB-121687 is fixed.
Comment by Joakim Gerth [ 2022-10-27 ]
One remaining item to implement is to apply increment / decrement.
Comment by Joakim Gerth [ 2022-11-03 ]
Found a tiny issue related to direction of sweetening fields. It needs to be fixed.
Comment by Joakim Gerth [ 2022-11-03 ]
{quote}Found a tiny issue related to direction of sweetening fields. It needs to be fixed. 
{quote}
Fixed.
Comment by Joakim Gerth [ 2022-11-07 ]
Another fix is required. The validation based on validation context is stateless, meaning that if a field is not disabled, it is assumed to be enabled. In app view model validation state is saved, so fields need to be explicitly enabled.
Comment by Joakim Gerth [ 2022-11-10 ]
{quote}Another fix is required. The validation based on validation context is stateless, meaning that if a field is not disabled, it is assumed to be enabled. In app view model validation state is saved, so fields need to be explicitly enabled.
{quote}
Fixed and merged.

================================================================================

[APP-46679] Bond beta: support make whole call provision Created: 2025-03-20  Updated: 2025-11-13  Resolved: 2025-09-17
Status:	Verified
Project:	APP
Component/s:	Pricing: Models
Fix Version/s:	Tbricks 2.31.2

Type:	New Feature	Priority:	Major
Reporter:	Leonid Konev	Assignee:	Leonid Konev
Resolution:	Fixed
Labels:	affected_auto_perf_tests, fi-board, qpm-qa-attention-needed

Issue Links:
Benefits from
benefits from	TB-120981	ParameterDefinition: slowness in CalculatedPropertyDefinition() operator	Open
benefits from	APP-47219	SQ: Slow hedging/+Order creation	Closed
Dependency
is blocked by	APP-47083	Bond models: yield to worst excluding make whole	Verified
blocks	APP-47098	FI MD provider: subscribe for sided versions of Bond yield	Verified
Documentation
documented in	DOC-5321	Bond beta: support make whole call provision	Done
Implementation
implements	PRD-19843	Yield Calculation Candeal bonds - Callable with MWC	Closed
Issue split
split to	APP-48232	Bond beta: polishing of MWC	Open

Description
We need to support yield-to-price-to-yield calculations for the make-whole call provision in pricing. While it is now clear to me how the calculation is supposed to be performed, it's not exactly clear where to get all the relevant parameters from and the exact behavior of those parameters is also a bit obscure. Nonetheless, let me provide description of the part that I do understand.

In general whole-call provision allows issuer of the bond (not the buyer/seller) to call it completely, but for a price equal to the sum of all future payments discounted with a spread over some benchmark yield. In particular, there are two parts in this calculation:
 1. Estimate call price based on
 * coupon rate
 * yield of some benchmark instrument (it looks like it's not pre-defined exactly!)
 * pre-defined spread over the benchmark yield
 * termination date (in the example I considered {{first call date != maturity date}} was used as such)
 * call date (in the example I considered the call was already announced)

2. Perform the yield-to-price-to-yield calculations based on:
 * call price estimated in the previous step
 * call date
 * coupon rate
 * settlement date
 * input yield or price

*Example calculation*
{code:java}
ghci> :{
ghci| let
ghci|   benchmark_yield = 0.042117653579773421
ghci|   wc_spread = 50e-4 
ghci|   basis = 360 
ghci|   coupon_rate = 5.5e-2
ghci|   days_next_coupon_to_termination = (9 - 6) * 30
ghci|   days_prev_coupon_to_call_date = 113 
ghci|   days_call_date_to_next_coupon = 180 - 113 
ghci|   estimated_call_price = ((1.0 + coupon_rate * days_next_coupon_to_termination / basis) / (1.0 + (benchmark_yield + wc_spread) / 2) ** (2 * days_next_coupon_to_termination / basis) + coupon_rate / 2) / (1.0 + (benchmark_yield + wc_spread) / 2) ** (2 * days_call_date_to_next_coupon / basis) - coupon_rate * days_prev_coupon_to_call_date / basis 
ghci|   yield = 1.2345e-2
ghci|   days_prev_coupon_to_settlement = 110 
ghci|   days_settlement_to_call_date = 3
ghci| in (estimated_call_price + coupon_rate * days_prev_coupon_to_call_date / basis) / (1 + yield * days_settlement_to_call_date / basis) - coupon_rate * days_prev_coupon_to_settlement / basis
ghci| :}
1.003720330122
ghci> 
{code}
!image-2025-03-20-16-49-00-660.png|thumbnail!

*Suggested solution*
 As discussed with [~ans], we need to perform the following changes:
 * add new attribute "Make whole termination date"
 * add new attribute "Make whole spread"; if it's empty, the bond does not have make whole feature
 * add new item named "Yield to make whole" to the "Bond yield type" enumeration
 * add new checkbox parameter "Make whole call announced" denoting that make whole call was announced, but its workout price is not fixed yet (so pricing needs to recalculate workout price dynamically based on the yield of the make-whole-benchmark-bond); "Workout date" instrument parameter has to be specified too when the checkbox is enabled
 * add strategy parameter "Bond yield type" for setting bond yield type in calculations of yields and fair prices
 * add new instrument parameter of tree node identifier type named "Make whole benchmark yield" for specifying make-whole-benchmark yield that should be used in discounting in calculation of the workout price; if this parameter is empty, the bond does not have make whole feature
 * pricing should enable extra subscription for the MW-benchmark yield and provide respective calculations in Fair market price, Fair bid, Fair ask, Bond yield, Bond bid yield and Bond ask yield if both "Make whole spread" and "Make whole benchmark yield" are not empty, and if one of the following conditions holds:
 ** if MWC is announced, but "Workout price" instrument parameter is not specified yet (i.e. "Make whole call announced" checkbox is enabled and "Workout date" instrument parameter is specified)
 ** if "Bond yield type" strategy parameter is set to "Yield to make whole"
 ** if "Bond yield type" strategy parameter is empty, but "Bond yield type" instrument parameter is set to "Yield to make whole"
 ** if "Bond yield type" strategy and instrument parameters are empty, and make whole _can_ be triggered (in this case YMW should be reported if it is the worst case);
 ** MWC should be considered as potentially executable if either make whole workout price floors at 100% of original notional, or the given bond price is less than or equal to the workout price discounted to the settlement date (=Valuation date + settlement days) with the make-whole-benchmark yield + spread (see "Workout price used" section below)
 * "Workout date used" for the MW is
 ** (same as for "vanilla" call) Workout date strategy parameter, if it is specified, otherwise
 ** (same as for "vanilla" call) Workout date instrument parameter, if it is specified, otherwise
 ** Settlement date + Min call notification period
 * "Workout price used" for the MW is
 ** (same as for "vanilla" call) Workout price strategy parameter, if it is specified, otherwise
 ** (same as for "vanilla" call) Workout price instrument parameter, if it is specified, otherwise
 ** Max of 100% of original notional and lump sum of all the payments between the workout date used and the make whole termination date discounted by the benchmark yield + MW spread (see {{estimated_call_price}} in the example above)

Note, calculation of MWC has implicit dependency on the side, that is respective side of the benchmark yield should be used in such calculations at all times.

Comments
Comment by Leonid Konev [ 2025-03-31 ]
Moving to 2.31 for now. This may be revised after we have a design for pricing from curve
Comment by Leonid Konev [ 2025-05-14 ]
I suggest that we approach the implementation in the following steps:
* add all the required metadata
* support YMW calculations after the MWC announcement
* support YMW calculations with either instrument or strategy parameter bond yield type specified to yield to make whole
* support YMW calculations in YTW enabled by some external trigger; note, this part is blocked by the lack of confirmation on our understanding of the trigger, and by APP-47083
Comment by Leonid Konev [ 2025-05-15 ]
[~LaglandT], could you please consider this?
Comment by Leonid Konev [ 2025-05-16 ]
Just for the record, one can identify instruments in the system for which YMW calculations are available based on the yield flag (if it's 380, then it is YMW). Unfortunately YMW calculations are not available for any instruments for which there was no MWC announcement, and that event is somewhat rare. Nonetheless, right now we have 4 instruments with these calculations in the tsd system, which should remain alive for the next month or so.
Comment by Tomas Lagland [ 2025-05-22 ]
Attaching an excel workbook [^APP-46679.xlsx]which replicates the yield-to-price calculation in the reference system for AIG, NEXA, OXY and STX.
Comment by Leonid Konev [ 2025-05-26 ]
Update description of the case with condition that enables consideration of the YMW in YTW calculation before MWC is announced. Also modified description of the MW workout price calculation by adding the flooring logic (max\{100%, ...}).
Comment by Leonid Konev [ 2025-06-03 ]
One more thing we need to account for within this case is enable calculation of fair bid and ask prices for the bond beta model. It is kinda mentioned in the description, but it may be worth explicitly mentioning that we don't have that supported at the moment at all
Comment by Leonid Konev [ 2025-06-13 ]
As discussed with [~ans], this moves forward to 2.31.
Comment by Anatoly Shibkov [ 2025-07-22 ]
I think it can be moved to 2.31.1. [~elizavetab] FYI.
Comment by Leonid Konev [ 2025-09-15 ]
Everything is merged to 2.31.2. Thanks to everyone involved
Comment by Leonid Konev [ 2025-09-16 ]
Apparently there are now duplicated definitions of make whole spread & make whole termination date calculated properties in 2.31.3
Comment by Leonid Konev [ 2025-09-16 ]
The fix is merged some time ago. [~LaglandT], please proceed with resolving the case
Comment by Tomas Lagland [ 2025-09-19 ]
To ease the configuration burden of the user I suggest the use of a single instrument property to indicate that the make whole feature is present: 'Make whole termination date'. 'Make whole spread' would no longer be necessary in order to decide whether the make whole feature is present or not. An error will, however, be generated when the call price has not been specified with 'Workout price' and 'Make whole spread' is missing. The real driver for this change is that currently, when make whole call is considered as part of the yield-to-worst, if make whole spread for some reason is missing, the user will not know, the make whole call feature will silently just not be considered for the yield-to-worst. But, with the suggested change an error will be generated highlighting that the make whole spread is missing.
Comment by Leonid Konev [ 2025-09-19 ]
My initial thoughts on the above are:
* Maturity date is a natural fallback for the make whole termination date, hence keeping the possibility of having the latter unspecified seems to me like a natural thing to do
* As I understand, the benchmark yield is usually taken from some less risky bonds, e.g. government bonds, so it doesn't seem like it should ever be the case that the make whole spread can remain empty or even 0.

But let's discuss this in more detail on Monday
Comment by Egor Budlov [ 2025-09-19 ]
Here is what I can see for now:
 # Please specify which attributes and parameters should have a column and which should not.
 Currently only _Make whole benchmark yield_ has one by default;
 # The _Yield curves_ app's [documentation|https://itivitinet.itiviti.com/display/TbricksMaster/Yield+Curves+app] is missing a lot of important information for yield curve setup, it needs to be significantly expanded.
 [~michaelk], [~p.kryzhanovskaya] FYI
 # The _Make whole benchmark yield_ field can be set but can not be cleared for some reason;
 # If the selected yield curve is empty, we should return errors in all related CVs. Currently we even return numbers in some cases.
 # Setting _Bond yield type_ to *Yield to make whole* does not seem to affect anything.
 Same with _Make whole termination date_ and _Make whole call announced_ - but maybe something is missed in the description.
 # Setting _Workout date_ recalculates yields, but clears _Workout price used_.
 # _Fair bid/ask_ remained empty from start to finish.

I am on a vacation next week so I will continue with verification in October. Please update the desctiption in the meantime to make it more readable and structured.
 For example, what does this mean setup-wise? Is make whole call announced or not? Is anything else required here?
{code:java}
if "Bond yield type" strategy and instrument parameters are empty, and make whole can be triggered (in this case YMW should be reported if it is the worst case);{code}
P.S. If there is a way to make less parameters to configure, I absolutely support it - the current setup of this feature seems a little too complex.
Comment by Michael Knyazev [ 2025-09-19 ]
bq. The Yield curves app's documentation is missing a lot of important information for yield curve setup

such as?
Comment by Leonid Konev [ 2025-09-22 ]
1. From troubleshooting standpoint, it could make sense to introduce columns for both make whole termination date and make whole spread. On the other hand, the more columns we add, the more options there are in the column browser, so I'm not 100% convinced it would be net beneficial.
3. I don't think we have any control over behavior of instrument parameters in the FE... so it doesn't look like an app-related issue
4. Definitely agree
5. This is unexpected as well. And no, I don't see anything missing in the description in this regard
6. Unexpected
7. Unexpected

Having more details on your setup could've been beneficial, given we actually have tests verifying at least some of the highlighted points, and they somehow pass.
Comment by Leonid Konev [ 2025-09-22 ]
[~LaglandT], as discussed, could you please compose a table describing different variations of setups and expected behaviors wrt MWC feature?
Comment by Tomas Lagland [ 2025-09-23 ]
The scope implemented is this Jira is  "Bond yield type = (<empty>|Yield to make whole)" for calculated values "Fair (bid|market|ask) price", "Bond (bid|<empty>|ask) yield", "(Bid|<empty>|Ask) workout date used" and "(Bid|<empty>|Ask) workout price  used". The instrument parameter "Make whole call announced" has not been fully integrated, but currently if it is set then there should be an error if workout date (yield end date) is not set.

 

 1. Columns for "Make whole spread" and "Make whole termination date" have been added when "Make whole call announced" was introduced. 
  3. "Make whole benchmark yield" can be cleared with a right-click and "Clear value".
  4. This behavour is not specific to bond yield type == yield to make whole. We are talking about cvs "(Bid|<empty>|Ask) workout date used" and "(Bid|<empty>|Ask) workout price used" here. For the 3 workout price used I think we should output errors when bond yield has an error, instead of returning empty values. For the 3 workout date used we could  output a correct workout date used apart from the case when "Bond yield type" is not specified with neither ip nor sp (corresponds to yield-to-worst). In this case we could output the same error as in the cv BondYield. I note that when no bond price is specified we output empty cvs (including bond yield). When the yield (rate) is empty we generate an error in fair cvs (an asymmetry - but maybe for some specific reason).

 5. "Make whole termination date" affects the call price. Obviously, if the call price is set explicitly with "Workout price", then make whole termination date will no longer have an effect on fair values, bond yields and workout price used. But, there is a much more interesting scenario: if the call price that is calculated based on make whole spread, make whole benchmark yield and make whole termination date is below the notional value of the bond, the call price used will be set to the notional, i.e. the call price is floored at the notional value and there is no dependence on make whole termination date. As the call price is visible in "Workout price used" we can use this to check whether we are in this scenario (if it is equal to notional then we are in this scenario). Similarly with make whole spread: if we increase it enough so that the calculated call price falls below the notional of the bond any further increase in make whole spread will not affect anything.

 6. If both a bond yield cv has a value and its corresponding workout price used cv also has a value, I cannot see how bond yield cv would still have a value after setting workout date and workout price would not. I am not able to replicate this scenario. A workout price used cv value should only "disappear" if the bond price is not available anymore (in which case the bond yield cv will become empty as well), or the workout price used can disappear if the bond yield cv gets an error.

7. I am not able to replicate this. With fair values we usually see an error or a value, but not empty.
Comment by Tomas Lagland [ 2025-09-23 ]
I think it helps to think in these terms when considering current behavior in "Bond yield type = Yield to make whole": Before a bond price can be converted to a  bond yield or vice versa, a call date and a call price need to be determined (just like when we have "Bond yield type = Yield to call/put date"). When we have this call date and call price the conversion between price and yield takes place just like when we have a non-callable bond ("Bond yield type = Yield to maturity"), the only difference is essentially that maturity date is replaced with call date and notional paid at maturity is replaced with call price. Call date can be provided as "Yield end date" and call price can be provided as "Workout price". If we do this - no make whole call parameters are needed. Specifying call date and call price is the way to indicate that the bond has been "make whole called" and call date and call price have been fixed.

In the following is considered the case when BOTH call date and call price are NOT specified explicitly.

The call date is known once "Yield end date" is specified, or, "Notification minimal days for call" is specified. In the latter case the call date is "now" (Valuation date) + "Notification minimal days for call".

The call price is known once "Workout price" is specified, or, "Make whole spread" and "Make whole benchmark yield" are specified. In the latter case the pricing app will calculate the call price as the sum of the bond cash flow between the call date and "Make whole termination date" discounted by the sum of the make whole spread and make whole benchmark yield (the notional is assumed to be paid at the make whole termination date instead of the maturity date).

The bond might be "make whole called" any time and the pricing app needs to determine/calculate the call date and the call price that would be used if the bond was make whole called. There is a point in time during the lifetime of the bond where it is no longer make whole callable. This is when the call date would fall after the "Make whole termination date". When this happens there will be an error "Make whole call is not active".

The below table summarizes the parameterization of "Bond yield type = Yield to make whole". The 2 first columns describes how we have specified call date and the next 2 columns describes how we have specified call price. 'Yield end date' has priority over 'Notification minimal days for call' and 'Workout price' has priority over 'Make whole spread' and 'Make whole benchmark yield' parameters, so for example: if both 'Yield end date' and 'Notification minimal days for call' are specified, the minimal days are ignored. Therefore having X in both column 1 and 2 is the same as having X in column 1.

The table shows the parameterizations (rows) which yield an OK outcome (either a calculated value or an error saying that the make whole call is not active).

 
||Workout date (sp or ip)||Notification minimal days for call||Workout price (sp or ip)||Make whole spread and Make whole benchmark yield||Make whole termination date||Outcome||
|X| |X| | |OK|
|X| | |X|X|OK|
| |X|X| | |OK|
| |X| |X|X|OK|

 

The result of a bug is visible in the table: specifying a 'Workout price' will skip the check of whether the call date is before the make whole termination date as 'Make whole termination date' is not required and the check could then not possibly take place as make whole termination date is part of the condition checked.
Comment by Tomas Lagland [ 2025-09-23 ]
In a future bug (specification of 'Make whole termination date' is not enforced when 'Workout price' is set) fix the following could also be addressed:
 1) In BondModelDataProvider do not create BenchmarkYieldProvider unless bond yield type is yield to make whole or <empty>.

2) Generate errors in this order A) ones related to determination of call date B) check whether the make whole call is active, i.e. call date is not after make whole termination date C) any errors related to call price (including those present in the benchmark yield provider). Share this error generating code between fair price and bond yield calculators.

3) I am thinking that "the bond has the make whole call feature" should be the same as "the bond should be considered in the yield to worst", so that "the bond has the make whole call feature" is only something that is relevant when bond yield type is <empty>. It might also make sense to reduce the number of parameters involved in the criterion for when the make whole feature is present in a bond to one: the presence of the "Make whole benchmark yield" parameter. Using maturity date as a default for make whole termination date makes sense and make whole spread would only be required when it actually is needed: the bond has a make whole call feature which still is active (i.e. we haven't passed the make whole termination date and no workout price has been specified).

4) Something not specific to make whole call but generally for 'Workout date used' and 'Workout price used': generate errors in the 3 sided versions of the latter one when an error would be generated in the associated 'Bond yield'. For the 3 sided versions of 'Workout date used' we can generated errors in the same scenario, or, when can actually provide the correct workout date used, apart from in ytw where we have to generate an error. In ytw we could actually embellish the error displayed in all 9 cvs by including the 'failing' workout date in the error.
Comment by Egor Budlov [ 2025-09-29 ]
[~lkonev], [~LaglandT] are you going to change anything here then?
Comment by Tomas Lagland [ 2025-09-30 ]
[~egor.budlov] The existing bug (presence of explicit Workout price hides the check that the call date <= make_whole_termination_date when bond_yield_type=yield_to_make_whole_call) will not be fixed anytime soon. Regarding the spec above I will try to clarify a bit about the following two points in the above spec:
 * if "Bond yield type" strategy and instrument parameters are empty, and make whole _can_ be triggered (in this case YMW should be reported if it is the worst case);
 * MWC should be considered as potentially executable if either make whole workout price floors at 100% of original notional, or the given bond price is less than or equal to the workout price discounted to the settlement date (=Valuation date + settlement days) with the make-whole-benchmark yield + spread (see "Workout price used" section below)

When both ip and sp "Bond yield type" are empty (= yield to worst) we want "Bond yield" to show the lowest of the 3 yields we would have gotten with bond yield type "yield to maturity", "yield to call" and "yield to make whole" and "Fair market price" to show the lowest of the 3 fair market prices we would have gotten with those 3 different bond yield types. The second point above taken from the spec describes a shortcut that can be taken in the implementation so that if certain conditions are met we assume the calculated yield/fair_price under bond_yield_type = yield_to_make_whole cannot possibly be the worst yield or fair price and the we don't calculate the yield/fair_price corresponding to bond_yield_type = yield_to_make_whole so that only 2 values need to be compared instead of 3 to decide which is the worst yield or fair price. I did not, however, implement this shortcircuit, so there will always be a comparison of 3 yields or 3 fair prices. Or to be more precise, there is also the chance that the call date for the make whole call would fall after the make_whole_termination_date and if that is the case the make whole call feature is not "active" anymore and we don't have a 3rd value. If the make_whole_spread is not set then the make whole call feature is not considered to exist, and there will be no 3rd value. The same holds for make_whole_termination_date, if it is not set, the make whole call feature is considered to not exist and there won't be a 3rd value.
Comment by Egor Budlov [ 2025-10-08 ]
Thanks, [~LaglandT]!
[~lkonev], are we going to close this case then and continue in another?
Comment by Leonid Konev [ 2025-10-16 ]
Created APP-48232 for polishing. Its description to be refined later, this is just to close the current case.
Comment by Leonid Konev [ 2025-10-16 ]
Setting the verified version on the basis of the previous discussions summarized above.
Comment by Mikhail Zibinskiy [ 2025-10-30 ]
After the changes done within this case, the time spent in Plus order during the Basket order 100 legs measurement of the ETF MM perf test increased from approximately 2.1 milliseconds to approximately 2.4 milliseconds in median.
 !Screenshot 2025-10-30 at 14.09.00.png|thumbnail! 
In 2.32, we see the growth after the [PR 26081|https://stash.orcsoftware.com/projects/TB/repos/apps/pull-requests/26081/overview]. In 2.31.3, the numbers are at the same level as in 2.32. Though we don't have historical numbers for 2.31.3, I guess it happened after the [PR 25753|https://stash.orcsoftware.com/projects/TB/repos/apps/pull-requests/25753/overview] to 2.31.2 and then was automerged to 2.31.3.

The full tracepoints tree of the measurement looks like the following.
{noformat}
[  0 µs] [str_thu_se1]  [2025-10-30 06:35:48.375592 CET] Trade received { cpu = 7, tid = 67275 } { message_size = 807 }
[ 44 µs] [str_thu_se1]    [2025-10-30 06:35:48.375636 CET] HandleTrade entry { cpu = 28, tid = 67115 } { queue_size = 0, group = Trade hedger (c80c2f45-d77c-11df-a329-15ad1dd294dd) }
[200 µs] [str_thu_se1]      [2025-10-30 06:35:48.375792 CET] StrategyAddRequest sent { cpu = 28, tid = 67115 } { message_size = 995 }
[205 µs] [str_thu_se1]        [2025-10-30 06:35:48.375796 CET] StrategyAddRequest received { cpu = 28, tid = 67115 } { message_size = 995 }
[343 µs] [str_thu_se1]          [2025-10-30 06:35:48.375935 CET] HandleConstructor entry { cpu = 23, tid = 91013 } { queue_size = 0, group = Basket order (43adf5df-6246-4670-b400-0d2bf0ea18cf) }
[4.1 ms] [str_thu_se1]            [2025-10-30 06:35:48.379688 CET] StreamOpenRequest (Strategy) sent (1 more collapsed; last delta 4.1 ms) { cpu = 23, tid = 91013 } { message_size = 182 }
[4.1 ms] [str_thu_se1]              [2025-10-30 06:35:48.379691 CET] StreamOpenRequest (Strategy) received { cpu = 23, tid = 91013 } { message_size = 182 }
[4.6 ms] [str_thu_se1]                [2025-10-30 06:35:48.380191 CET] StreamSnapshotDone (Strategy) sent { cpu = 29, tid = 67116 } { message_size = 55 }
[4.6 ms] [str_thu_se1]                  [2025-10-30 06:35:48.380207 CET] StreamSnapshotDone (Strategy) received { cpu = 29, tid = 67116 } { message_size = 55 }
[4.6 ms] [str_thu_se1]                    [2025-10-30 06:35:48.380215 CET] HandleSnapshotEnd entry (StrategyInstance) { cpu = 23, tid = 91013 } { queue_size = 1, group = Basket order (43adf5df-6246-4670-b400-0d2bf0ea18cf), message_id = 131 (StrategyInstance) }
[4.7 ms] [str_thu_se1]                      [2025-10-30 06:35:48.380308 CET] StrategyAddRequest sent { cpu = 23, tid = 91013 } { message_size = 1387 }
[4.7 ms] [str_thu_se1]                        [2025-10-30 06:35:48.380311 CET] StrategyAddRequest received { cpu = 23, tid = 91013 } { message_size = 1387 }
[4.8 ms] [str_thu_se1]                          [2025-10-30 06:35:48.380436 CET] HandleConstructor entry { cpu = 26, tid = 67651 } { queue_size = 0, group = Plus order (3c68a749-cd6b-11e0-933b-245e0d1c06b7) }
[8.5 ms] [str_thu_se1]                            [2025-10-30 06:35:48.384126 CET] Order sent { cpu = 26, tid = 67651 } { message_size = 763 }
{noformat}

The affected tracepoints pair is *{{HandleConstructor entry - Order sent}}*
Comment by Vasiliy Markin [ 2025-10-30 ]
There's the same latency increase in Basket order 1 leg measurement, which is easier to trace and log.

It looks like the time is being spent somewhere in the engine.
When adding additional tracepoints:
{noformat}
[293 µs] [al3_thu_se1]                      [2025-10-30 22:35:03.437562 CET] HandleConstructor entry { cpu = 10, tid = 1988902 } { queue_size = 0, group = Plus order (3c68a749-cd6b-11e0-933b-245e0d1c06b7) } { pet = 4b992142-b5d8-11f0->
[2.7 ms] [al3_thu_se1]                        [2025-10-30 22:35:03.439969 CET] pe:open_stream (TreeNode) { cpu = 10, tid = 1988902 } { message_id = 1172 (TreeNode) } { pet = 4b997fb6-b5d8-11f0-8bd0-39e4887ce722, pet_parent = 4b992142->
[2.7 ms] [al3_thu_se1]                          [2025-10-30 22:35:03.439974 CET] pe:wait_for_snapshot (TreeNode) { cpu = 10, tid = 1988902 } { group = Plus order (3c68a749-cd6b-11e0-933b-245e0d1c06b7), message_id = 1172 (TreeNode) } {>
[3.1 ms] [al3_thu_se1]                            [2025-10-30 22:35:03.440342 CET] HandleStreamOpened entry (TreeNode) { cpu = 10, tid = 1988902 } { queue_size = 0, group = Plus order (3c68a749-cd6b-11e0-933b-245e0d1c06b7), message_id>
[3.1 ms] [al3_thu_se1]                              [2025-10-30 22:35:03.440343 CET] HandleStreamOpened exit (TreeNode) { cpu = 10, tid = 1988902 } { group = Plus order (3c68a749-cd6b-11e0-933b-245e0d1c06b7), message_id = 1172 (TreeNo>
[3.1 ms] [al3_thu_se1]                            [2025-10-30 22:35:03.440345 CET] HandleSnapshotEnd entry (TreeNode) { cpu = 10, tid = 1988902 } { queue_size = 1, group = Plus order (3c68a749-cd6b-11e0-933b-245e0d1c06b7), message_id >
[3.1 ms] [al3_thu_se1]                              [2025-10-30 22:35:03.440350 CET] HandleSnapshotEnd exit (TreeNode) { cpu = 10, tid = 1988902 } { group = Plus order (3c68a749-cd6b-11e0-933b-245e0d1c06b7), message_id = 1172 (TreeNod>
[2.7 ms] [al3_thu_se1]                          [2025-10-30 22:35:03.439975 CET] pe:add_event { cpu = 10, tid = 1988902 } { pet = 4b998006-b5d8-11f0-8bd0-39e4887ce722, pet_parent = 4b997fb6-b5d8-11f0-8bd0-39e4887ce722 }
[2.7 ms] [al3_thu_se1]                          [2025-10-30 22:35:03.439976 CET] pe:add_event { cpu = 10, tid = 1988902 } { pet = 4b998010-b5d8-11f0-8bd0-39e4887ce722, pet_parent = 4b997fb6-b5d8-11f0-8bd0-39e4887ce722 }
[2.8 ms] [al3_thu_se1]                          [2025-10-30 22:35:03.440033 CET] plus_order:enter_constructor { cpu = 10, tid = 1988902 } { app_custom1 = 0, app_custom2 = 0 } { pet = 4b998240-b5d8-11f0-8bd0-39e4887ce722, pet_parent = >
{noformat}

There's not much other activity in the engine during this 2.5 ms
{noformat}
[2025-10-30 22:35:03.437562 CET] pe:handle_constructor_entry { cpu = 10, tid = 1988902, procname = al3_thu_se1 } { queue_size = 0, group = Plus order (3c68a749-cd6b-11e0-933b-245e0d1c06b7) } { hostname = albert-3.orcsoftware.com } { p>
[2025-10-30 22:35:03.437565 CET] pe:update_exit { cpu = 8, tid = 1966915, procname = al3_thu_se1 } { hostname = albert-3.orcsoftware.com } { pet = 4b9921e2-b5d8-11f0-8bd0-39e4887ce722, pet_parent = 4b992110-b5d8-11f0-8bd0-39e4887ce722>
[2025-10-30 22:35:03.437573 CET] protocol_out_strategy:strategy_instance { cpu = 8, tid = 1966915, procname = al3_thu_se1 } { hostname = albert-3.orcsoftware.com, message_size = 145 } { pet = 4b992232-b5d8-11f0-8bd0-39e4887ce722, pet_>
[2025-10-30 22:35:03.437574 CET] protocol_in_strategy:strategy_instance { cpu = 8, tid = 1966915, procname = al3_thu_se1 } { hostname = albert-3.orcsoftware.com, message_size = 145 } { pet = 4b99223c-b5d8-11f0-8bd0-39e4887ce722, pet_p>
[2025-10-30 22:35:03.437575 CET] pe:add_event { cpu = 8, tid = 1966915, procname = al3_thu_se1 } { hostname = albert-3.orcsoftware.com } { pet = 4b992246-b5d8-11f0-8bd0-39e4887ce722, pet_parent = 4b99223c-b5d8-11f0-8bd0-39e4887ce722 }
[2025-10-30 22:35:03.437576 CET] protocol_in:message_processed { cpu = 8, tid = 1966915, procname = al3_thu_se1 } { hostname = albert-3.orcsoftware.com } { pet = 4b992250-b5d8-11f0-8bd0-39e4887ce722, pet_parent = 4b99223c-b5d8-11f0-8b>
[2025-10-30 22:35:03.437577 CET] pe:update_entry { cpu = 8, tid = 1966915, procname = al3_thu_se1 } { hostname = albert-3.orcsoftware.com } { pet = 4b99225a-b5d8-11f0-8bd0-39e4887ce722, pet_parent = 4b991e04-b5d8-11f0-8bd0-39e4887ce72>
[2025-10-30 22:35:03.437580 CET] pe:handle_strategy_update_exit { cpu = 19, tid = 1991253, procname = al3_thu_se1 } { group = Trade hedger (c80c2f45-d77c-11df-a329-15ad1dd294dd) } { hostname = albert-3.orcsoftware.com } { pet = 4b9922>
[2025-10-30 22:35:03.437583 CET] pe:handle_strategy_update_entry { cpu = 19, tid = 1991253, procname = al3_thu_se1 } { queue_size = 0, group = Trade hedger (c80c2f45-d77c-11df-a329-15ad1dd294dd) } { hostname = albert-3.orcsoftware.com>
[2025-10-30 22:35:03.437584 CET] pe:handle_strategy_update_exit { cpu = 19, tid = 1991253, procname = al3_thu_se1 } { group = Trade hedger (c80c2f45-d77c-11df-a329-15ad1dd294dd) } { hostname = albert-3.orcsoftware.com } { pet = 4b9922>
[2025-10-30 22:35:03.437598 CET] pe:update_exit { cpu = 8, tid = 1966915, procname = al3_thu_se1 } { hostname = albert-3.orcsoftware.com } { pet = 4b99232c-b5d8-11f0-8bd0-39e4887ce722, pet_parent = 4b99225a-b5d8-11f0-8bd0-39e4887ce722>
[2025-10-30 22:35:03.437601 CET] pe:handle_strategy_request_reply_entry { cpu = 8, tid = 1966915, procname = al3_thu_se1 } { queue_size = 0, group = Basket order (43adf5df-6246-4670-b400-0d2bf0ea18cf) } { hostname = albert-3.orcsoftwa>
[2025-10-30 22:35:03.437603 CET] pe:handle_strategy_request_reply_exit { cpu = 8, tid = 1966915, procname = al3_thu_se1 } { group = Basket order (43adf5df-6246-4670-b400-0d2bf0ea18cf) } { hostname = albert-3.orcsoftware.com } { pet = >
[2025-10-30 22:35:03.439969 CET] pe:open_stream { cpu = 10, tid = 1988902, procname = al3_thu_se1 } { message_id = 1172 (TreeNode) } { hostname = albert-3.orcsoftware.com } { pet = 4b997fb6-b5d8-11f0-8bd0-39e4887ce722, pet_parent = 4
{noformat}

The one difference I could find in the samples is considerable more frequent LegOrderManager::SetStrategyParent
 !sample_before_changes.png|thumbnail! 
 !sample_after_changes.png|thumbnail! 

 [^before_tbsample_al2_thu_se1_albert-2_20251030-211304.svg]  
[^after_tbsample_al3_thu_se1_albert-3_20251030-211252.svg] 

[~pavel.lyubkin] [~anton.elkin] could you take a look please? There might be some resolve here that makes it so slow.
Basket order constructor also has 2ms delay in the same probes and it also has increased by a couple of hundred micros.

The logs have just a couple of messages around this delayed time.
Logs, traces and samples:
{noformat}
-rwxrwxrwx 1 bamboo tbeng  928367017 Oct 30 22:48 before_se_dump.log
-rwxrwxrwx 1 bamboo tbeng      75470 Oct 30 22:48 before_pe_stats.trc
-rwxrwxrwx 1 bamboo tbeng     704078 Oct 30 22:48 tbsample_al2_thu_se1_albert-2_20251030-211304.svg
-rwxrwxrwx 1 bamboo tbeng  226142598 Oct 30 22:48 before_trees.trc
-rwxrwxrwx 1 bamboo tbeng       9082 Oct 30 22:48 before_stats.trc
drwxrwxrwx 3 bamboo tbeng       4096 Oct 30 22:50 before_raw_traces
drwxrwxrwx 3 bamboo tbeng       4096 Oct 30 22:50 before_raw_traces_pe
-rwxrwxrwx 1 bamboo tbeng 1282263965 Oct 30 22:54 after_pe_trees.trc
-rwxrwxrwx 1 bamboo tbeng     120113 Oct 30 22:54 after_pe_stats.trc
-rwxrwxrwx 1 bamboo tbeng  304907104 Oct 30 22:54 after_trees.trc
-rwxrwxrwx 1 bamboo tbeng      19308 Oct 30 22:54 after_stats.trc
-rwxrwxrwx 1 bamboo tbeng  860327516 Oct 30 22:54 after_se_dump.log
drwxrwxrwx 3 bamboo tbeng       4096 Oct 30 22:55 after_raw_traces
drwxrwxrwx 3 bamboo tbeng       4096 Oct 30 22:55 after_raw_traces_pe
-rwxrwxrwx 1 bamboo tbeng     601346 Oct 30 22:55 tbsample_al3_thu_se1_albert-3_20251030-211252.svg
-rwxrwxrwx 1 bamboo tbeng 1681441613 Oct 30 23:12 after_pe_events.trc
/tb/shared/tbricks/JIRA/APP-46679
{noformat}
Comment by Leonid Konev [ 2025-10-31 ]
It seems like the issue is unrelated to the changes implemented within this case after all. Can we please move the discussion into a new one?
Comment by Vasiliy Markin [ 2025-10-31 ]
After discussion with [~anton.elkin] the issue is more or less clear.

That much time is being spent in getting calculated properties definitions.
{noformat}
HandleConstructor entry - plus_order:get_definitions                                 54      9 µs     12 µs     16 µs     19 µs     19 µs    0.0%     19 µs
  plus_order:get_definitions - plus_order:got_definitions                            54    2.4 ms    2.5 ms    2.6 ms    3.3 ms    3.3 ms    0.0%    3.3 ms
   plus_order:got_definitions - plus_order:enter_constructor                         54     79 µs     86 µs     98 µs    109 µs    109 µs    0.0%    109 µs
{noformat}
apps/shared/order_minion/MinionParameters.h:32
{noformat}
    TRACEPOINT_GLOBAL(get_definitions);
    Definitions defs;
    GetDefinitions(defs);
    m_cpSubstitutions = ValidatorHelper::GetDefinitionsMap(defs);
    TRACEPOINT_GLOBAL(got_definitions);
{noformat}
All definitions available in the system are requested.
 As, I suppose, new calculated properties were created in the scope of the case, they are now fetched when creating PlusOrder.
 Probably some other apps are also affected (hedgers, fair price order, greeks order..)

It's a regression after APP-38660.

Will continue with improvements in scope of APP-47219 and TB-120981.

================================================================================

[APP-47219] SQ: Slow hedging/+Order creation Created: 2025-05-29  Updated: 2025-12-23  Resolved: 2025-11-11
Status:	Closed
Project:	APP
Component/s:	Order minion
Affects Version/s:	Tbricks 2.21
Fix Version/s:	Tbricks 2.29, Tbricks 2.32

Type:	Performance regression	Priority:	Critical
Reporter:	Damien Bishop	Assignee:	Vasiliy Markin
Resolution:	Fixed
Labels:	madura_perf, mimosa_dependency, regression

Issue Links:
Benefits from
benefits to	APP-46679	Bond beta: support make whole call provision	Verified
Regression
is a regression after	APP-38660	Order minion: Support minion parameter validation for app view model updates	Closed
Relation
is related to	SPRJ-69051	Plus Order Traces	Done
is related to	PRD-20566	Spread quoter: introduce app pooling for child hedges	Product Change Assessment
is related to	APP-48406	OM: Minion parameters should have own cache with CP defs	Open
is related to	TB-120981	ParameterDefinition: slowness in CalculatedPropertyDefinition() operator	Open
is related to	APP-47817	Spread quoter: support app pooling for child hedges	In Progress
is related to	SERV-372938	Madura: Slippage	Resolved

Description
Madura a new logo has recently gone live using Tbricks and are spread quoting spots vs futures. 

As some background they are currently using Flex Trade side by side with Tbricks and so though we have no contractual obligations to match them in any metric we are being compared side by side. Their architecture is not ideal but is almost the same between the two systems. Futures MD is from QH, futures trading is through DB (But on our side we have a UL bridge so an extra few ms) spot MD and TR is from Reactive markets. 

After going live with Tbricks Madura are seeing higher levels of slippage than with FT.  This has resulted in them not using Tbricks right now. There's been lots of work done to improve the latency such as removing FW for Reactive, trimming down field mappings in BTCS SP GW for DB, onload tuning etc. I believe we're almost at the point where there are no more architectural improvements than can be made (other than removing the bridge and using a Tbricks FIX GW).

The main difference that is left is hedging logic. In FT the trader can configure their hedge to be sent at calculated price - some ticks for sweetening. This is a day order and after a short time in the book this hedge is then sent at BBO - some ticks until filled. 
This differs from what we can do in Tbricks. In Tbricks our fast hedging solution is sending an IOC but doesn't rest at all. We can do IOC at market but this seems to result in too many bad trades in this setup/market. 
We of course then have our other hedging method when skipping IOC and using plus order. Here we can send a non IOC that is sweetened and rests in the book for a configurable amount of time. This isn't quite the same as FT which then follows BBO but should be closer at least in initial hedge logic. 

It's important to note that Madura use hidden and the RTT to DB is relatively slow therefore missing the IOC is costly and is another reason they tried IOC at market. So ideally they need to get a sweetened hedge out first time around.

The problem here though is +Order creation is extremely slow, often around 14ms. The assumption is this is due to synchronous instrument resolution etc.
EG
 !image-2025-05-29-12-25-21-431.png|thumbnail! 
Here we are skipping IOC and get a fill on the quote leg in~3ms and SQ sends the hedge at 644, however its not until 658 that +Order is created and sends the hedge order so 14ms  of delay.

What can be done to improve this?

Any engine settings? 
App pooling? 
+Order pre-creation?
More configurable hedging done from SQ itself so it can use plain orders?

SE properties
{quote}
$ tbcomponent get prd_se1
  short_name : prd_se1
  identifier : b612cb86-0e35-11f0-8ff0-d62afaedcf1f
      system : mdr_prd
        node : se-eqx-madprd01
        type : Strategy Engine
         PID : 3538534
       state : Running
api_versions : 2.30.v363, 2.29.v355, 2.28.v352, 2.27.v348, 2.26.v344
auto_restart : yes
 module_name : tbricks_plugin_engine
        name : Strategy Engine
    platform : tbricks-2.30.124
  start_days : Sunday,Monday,Tuesday,Wednesday,Thursday
  start_time : 17:42
   stop_days : Monday,Tuesday,Wednesday,Thursday,Friday
   stop_time : 17:03
    timezone : America/New_York

{quote}

Comments
Comment by Anton El'kin [ 2025-05-30 ]
[~rk], fyi as we discussed. 
[~vak], also for you.
Comment by Mikael Klingman [X] [ 2025-06-05 ]
Madura is starting to become impatient. They are not using a system that they are paying for.  We are losing against Flextrade, a competitor that we clearly don't consider a faster solution than Tbricks.

We have done various changes, and now we are down to two, possibly three things, where improvements can be made:
 # Create a Tbricks native gateway to DB, instead of using a UL Bridge based connection; possibly saving around 2 ms (APT-670)
 # Investigate if the QH flow is handled optimally; uncertain what this can achieve (TB-134616)
 # Addressing the difference in the hedging logic, and optimizing the +Order creation (this case)

Even though we don't know the impact on the total roundtrip trip with a change of the hedge logic to correspond Flextrade's, we know that this is a major difference between the Flextrade setup on the Tbricks one. My personal belief is that if we don't address this difference, we will not be able to make progress.
Comment by Mikael Klingman [X] [ 2025-06-06 ]
Can we at least proceed with understanding the effort required to introduce functionality enabling us to mirror Flextrade's hedging logic?
Comment by Anton El'kin [ 2025-06-12 ]
My thought regarding possible solution inside the app:
* Using order template for hedge(IOC) and quote order
* Using app pooling(Change strategy create request to the async one) for the second phase of the hedging.
Comment by Slava Kaminskiy [ 2025-06-13 ]
As discussed, there are a few things to follow up:
# Flex trade sends "today" hedge order instead of "Immediate", which might actually be a deal-breaker here. So a first improvement we could consider in our SQ would be:
** Change validity of the initial hedge order form "Immediate" to "Today"
** Add a timer for that order. Once the timer expires we'll replace it with Plus Order.
** [~anton.elkin] will estimate the change
# Get some performance measurements in Madura's system to have a scientific proof for our assumptions around what is slow in TB. [~damien.bishop] might have some traces already - he'll dig into them. If them are not a good fit, then he needs to ask perf team for help.
# Get a description of how Flex Trade spreading logic works to make sure we are not missing on some important steps/differences in that logic. [~damien.bishop] will follow up on this with Madura.
Comment by Anton El'kin [ 2025-06-13 ]
Also, [~team_performance] might help here.
Comment by Harshad Hule [X] [ 2025-06-17 ]
We were able to get traces for 11th June when the trader tried some trades in Production:
 !Traces_11th_June.png|thumbnail! 

I calculated the time taken by Plus Order to send a hedge when SQ directed a "Sent  hedge" from logs:
{code}
10:12:32.744227,10:12:32.762288,0.018061
11:10:17.523870,11:10:17.540858,0.016988
10:42:22.906408,10:42:22.919148,0.012740
10:13:18.236539,10:13:18.248197,0.011658
10:56:58.271735,10:56:58.283258,0.011523
{code}

Max being the very first hedge of the day taking 18ms.
Low: 6ms.

I am trying to check if there are any probes we can add to get some traces for "Plus order" so that we can understand why is Plus order taking so long.
Comment by Stepan Edamenko [ 2025-06-18 ]
!screenshot-1.png|thumbnail! 
The part having 18ms doesn't have +Order on the path, looks like initial IOC hedge. We have to check properly before performing the IOC -> Today change. Do you have raw traces?
Comment by Damien Bishop [ 2025-06-18 ]
AFAIU the part with 18ms outlier is the encoding in the FIX gateway itself. 
That part of the trace is from when SQ has sent an order to trading framework and then FIX gateway
Comment by Stepan Edamenko [ 2025-06-18 ]
Ok, it would be good to see the paths containing +Order creation.
Comment by Harshad Hule [X] [ 2025-06-18 ]
[~stepane], we were able to take traces for Plus order in the UAT when we sent a hedge order on Internal Market.

 

In the UAT against Internal market, Plus Order took roughly ~10ms.
 Traces were taken at 3 different intervals & all exhibited HandleConstructor taking ~9ms.
{code:java}
Plus order (3c68a749-cd6b-11e0-933b-245e0d1c06b7)
=================================================================================================
                        #      50%      80%      95%      99%    99.9%  >2x80%       SUM      MAX
=================================================================================================
HandleStreamOpened     24     3 µs     6 µs     8 µs     9 µs     9 µs    0.0%    0.1 ms     9 µs
HandleSnapshotEnd      24     6 µs    22 µs   285 µs   556 µs   556 µs   16.7%    1.5 ms   556 µs
HandleOrderUpdate      14   148 µs   208 µs   364 µs   364 µs   364 µs    0.0%    2.1 ms   364 µs
HandleOrderBook         5   107 µs   115 µs   232 µs   232 µs   232 µs   20.0%    0.6 ms   232 µs
HandleRequestReply      5    40 µs    42 µs    46 µs    46 µs    46 µs    0.0%    0.2 ms    46 µs
HandleBestPrice         5    41 µs    55 µs   233 µs   233 µs   233 µs   20.0%    0.4 ms   233 µs
HandleInstrumentStatus  4    20 µs    29 µs    29 µs    29 µs    29 µs    0.0%    0.1 ms    29 µs
HandleStatistics        4    43 µs    74 µs    74 µs    74 µs    74 µs    0.0%    0.2 ms    74 µs
HandleConstructor       4   8.7 ms   9.2 ms   9.2 ms   9.2 ms   9.2 ms    0.0%   34.7 ms   9.2 ms
HandleRunRequest        4     6 µs    32 µs    32 µs    32 µs    32 µs    0.0%    0.1 ms    32 µs
HandleTimerEvent        2    57 µs   317 µs   317 µs   317 µs   317 µs    0.0%    0.4 ms   317 µs
HandlePauseRequest      1   764 µs   764 µs   764 µs   764 µs   764 µs    0.0%    0.8 ms   764 µs
=================================================================================================
{code}
 

Traces & Plus order plugin logs are kept at the following location:
{code:java}
tbricks@njord [qa_admin_sys] ~ $ ls -lrth /tb/shared/tbricks/JIRA/APP-47219
total 172K
-rwxr-x--- 1 tbricks tbricks 130K Jun 18 11:03 Plus_Order_Non_Immediate_Sent.log
-rw-r----- 1 tbricks tbricks  11K Jun 18 11:04 plus_order_trace3
-rw-r----- 1 tbricks tbricks 9.6K Jun 18 11:04 plus_order_trace2
-rw-r----- 1 tbricks tbricks  11K Jun 18 11:05 plus_order_trace1
{code}
 

Do you think this information is enough ?
Comment by Stepan Edamenko [ 2025-06-18 ]
That's better, but could we have "-k trees" / "-k events"?
Comment by Harshad Hule [X] [ 2025-06-18 ]
Thanks [~stepane], attached both events & trees for the latest traces:
{code}
tbricks@njord [qa_admin_sys] ~ $ ls -lrth /tb/shared/tbricks/JIRA/APP-47219
total 51M
-rwxrwxrwx 1 tbricks      tbricks  130K Jun 18 11:03 Plus_Order_Non_Immediate_Sent.log
-rwxrwxrwx 1 tbricks      tbricks   11K Jun 18 11:04 plus_order_trace3
-rwxrwxrwx 1 tbricks      tbricks  9.6K Jun 18 11:04 plus_order_trace2
-rwxrwxrwx 1 tbricks      tbricks   11K Jun 18 11:05 plus_order_trace1
-rwxr-xr-x 1 harshad.hule orcgroup  48M Jun 18 11:56 plus_order_trace3.events             <<<<<<<<<<<<<<<<<<
-rwxr-xr-x 1 harshad.hule orcgroup 3.0M Jun 18 11:56 plus_order_trace3.trees             <<<<<<<<<<<<<<<<<<
{code}
Comment by Anton El'kin [ 2025-06-18 ]
[~harshad.hule], are these traces for SQ child plus order or it's just an independent plus order?
Comment by Harshad Hule [X] [ 2025-06-18 ]
[~anton.elkin], yes, they are the child Plus order of SQ.
Comment by Anton El'kin [ 2025-06-18 ]
Here is the path with tree nodes that should be skipped in the case of a child plus order:

{noformat}
[ 350 µs] [ uat_sc]          StrategyAddRequest received
[ 782 µs] [ uat_sc]            protocol_in:message_processed
[ 1.2 ms] [ uat_sc]            HandleConstructor entry { queue_size = 0, group = Plus order (3c68a749-cd6b-11e0-933b-245e0d1c06b7) }
[ 9.1 ms] [ uat_sc]              pe:wait_for_snapshot (TreeNode) { group = Plus order (3c68a749-cd6b-11e0-933b-245e0d1c06b7) }
[10.8 ms] [ uat_sc]                HandleStreamOpened entry (TreeNode) { queue_size = 0, group = Plus order (3c68a749-cd6b-11e0-933b-245e0d1c06b7) }
[10.8 ms] [ uat_sc]                  HandleStreamOpened exit (TreeNode) { group = Plus order (3c68a749-cd6b-11e0-933b-245e0d1c06b7) }
[10.9 ms] [ uat_sc]                HandleSnapshotEnd entry (TreeNode) { queue_size = 1, group = Plus order (3c68a749-cd6b-11e0-933b-245e0d1c06b7) }
[10.9 ms] [ uat_sc]                  HandleSnapshotEnd exit (TreeNode) { group = Plus order (3c68a749-cd6b-11e0-933b-245e0d1c06b7) }
{noformat}
Comment by Stepan Edamenko [ 2025-08-15 ]
Let's start with app pooling: APP-47817 (and TST-120864 to test the improvements).
Comment by Vasiliy Markin [ 2025-10-31 ]
After adding several unrelated new calculated properties in scope of APP-46679, the latency of Basket order and Plus order creation has increased in ETF MM test.
 !etf_mm.png|thumbnail! 

It increased from ~2ms to ~2.4ms when getting calculated properties definitions
{noformat}
HandleConstructor entry - plus_order:get_definitions                                 54      9 µs     12 µs     16 µs     19 µs     19 µs    0.0%     19 µs
  plus_order:get_definitions - plus_order:got_definitions                            54    2.4 ms    2.5 ms    2.6 ms    3.3 ms    3.3 ms    0.0%    3.3 ms
   plus_order:got_definitions - plus_order:enter_constructor                         54     79 µs     86 µs     98 µs    109 µs    109 µs    0.0%    109 µs
{noformat}

apps/shared/order_minion/MinionParameters.h:32
{noformat}
    TRACEPOINT_GLOBAL(get_definitions);
    Definitions defs;
    GetDefinitions(defs);
    m_cpSubstitutions = ValidatorHelper::GetDefinitionsMap(defs);
    TRACEPOINT_GLOBAL(got_definitions);
{noformat}

Would it be possible to request only the required properties or add a cache to the engine?
Comment by Anton El'kin [ 2025-11-05 ]
I marked this as a regression due to changes from APP-38660 introduced huge delay.
Comment by Vasiliy Markin [ 2025-11-05 ]
When [hardcoding |https://stash.orcsoftware.com/projects/TB/repos/apps/commits/56e0e80c14bde638775b83af896746141abd73c2#shared%2Forder_minion%2FMinionParameters.h]required definitions for Plus Order in the OrderMinion:
{noformat}
HandleConstructor entry - plus_order:get_definitions                    66     11 µs     13 µs     19 µs     24 µs     24 µs    0.0%     24 µs
   plus_order:get_definitions - plus_order:got_definitions              66     38 µs     42 µs     47 µs     57 µs     57 µs    0.0%     57 µs
     plus_order:got_definitions - plus_order:enter_constructor          66     96 µs    105 µs    117 µs    124 µs    124 µs    0.0%    124 µs
{noformat}
Comment by Roman Shevelev [ 2025-11-10 ]
[~team_performance], could you please verify that the latency is improved in fresh 2.32 version?
Comment by Vasiliy Markin [ 2025-11-10 ]
The latency is much better now
 !order_minion.png|thumbnail! 

http://perf.orcsoftware.com/views/Performance/Timelinecompare/81beeedb-ea75-4e8b-a55a-88db3402df24/da5a56d7-e558-4b75-9595-f461b25d03c0

Could we backport it please to the earliest supported version?
Comment by Anton El'kin [ 2025-11-11 ]
Backported to 2.29.
Comment by Vasiliy Markin [ 2025-11-11 ]
The latency is low on 2.29 as well
Comment by Damien Bishop [ 2025-11-12 ]
Looks like this was actually the golden bullet.
Delivered to Madura yesterday. Checked logs in Prod and all latency seen there gone. 

Traces taken in UAT
Before;
{noformat}
Plus order (3c68a749-cd6b-11e0-933b-245e0d1c06b7)
=================================================================================================
                        #      50%      80%      95%      99%    99.9%  >2x80%       SUM      MAX
=================================================================================================
HandleStreamOpened     24     3 µs     6 µs     8 µs     9 µs     9 µs    0.0%    0.1 ms     9 µs
HandleSnapshotEnd      24     6 µs    22 µs   285 µs   556 µs   556 µs   16.7%    1.5 ms   556 µs
HandleOrderUpdate      14   148 µs   208 µs   364 µs   364 µs   364 µs    0.0%    2.1 ms   364 µs
HandleOrderBook         5   107 µs   115 µs   232 µs   232 µs   232 µs   20.0%    0.6 ms   232 µs
HandleRequestReply      5    40 µs    42 µs    46 µs    46 µs    46 µs    0.0%    0.2 ms    46 µs
HandleBestPrice         5    41 µs    55 µs   233 µs   233 µs   233 µs   20.0%    0.4 ms   233 µs
HandleInstrumentStatus  4    20 µs    29 µs    29 µs    29 µs    29 µs    0.0%    0.1 ms    29 µs
HandleStatistics        4    43 µs    74 µs    74 µs    74 µs    74 µs    0.0%    0.2 ms    74 µs
HandleConstructor       4   8.7 ms   9.2 ms   9.2 ms   9.2 ms   9.2 ms    0.0%   34.7 ms   9.2 ms
HandleRunRequest        4     6 µs    32 µs    32 µs    32 µs    32 µs    0.0%    0.1 ms    32 µs
HandleTimerEvent        2    57 µs   317 µs   317 µs   317 µs   317 µs    0.0%    0.4 ms   317 µs
HandlePauseRequest      1   764 µs   764 µs   764 µs   764 µs   764 µs    0.0%    0.8 ms   764 µs
=================================================================================================
{noformat}
After;
{noformat}
Plus order (3c68a749-cd6b-11e0-933b-245e0d1c06b7)
================================================================================================
                        #      50%      80%      95%      99%    99.9%  >2x80%      SUM      MAX
================================================================================================
HandleOrderUpdate      28    63 µs    77 µs   103 µs   341 µs   341 µs    3.6%   1.9 ms   341 µs
HandleStreamOpened     20     6 µs     7 µs     8 µs     9 µs     9 µs    0.0%   0.1 ms     9 µs
HandleSnapshotEnd      20    13 µs    26 µs    30 µs    31 µs    31 µs    0.0%   0.3 ms    31 µs
HandleBestPrice        14    26 µs    44 µs   103 µs   103 µs   103 µs    7.1%   0.5 ms   103 µs
HandleRequestReply     11    12 µs    18 µs    19 µs    19 µs    19 µs    0.0%   0.2 ms    19 µs
HandleInstrumentStatus  7    12 µs    13 µs    13 µs    13 µs    13 µs    0.0%   0.1 ms    13 µs
HandleConstructor       6   1.2 ms   1.3 ms   1.3 ms   1.3 ms   1.3 ms    0.0%   7.0 ms   1.3 ms
HandleRunRequest        6     6 µs     7 µs    13 µs    13 µs    13 µs    0.0%   0.0 ms    13 µs
HandleValidateRequest   4   957 µs   1.0 ms   1.0 ms   1.0 ms   1.0 ms    0.0%   3.8 ms   1.0 ms
HandleModifyRequest     3   459 µs   846 µs   846 µs   846 µs   846 µs    0.0%   1.8 ms   846 µs
HandleDeleteRequest     1   390 µs   390 µs   390 µs   390 µs   390 µs    0.0%   0.4 ms   390 µs
================================================================================================

{noformat}

HandleConstructor  down from 9ms to 1.2ms. Will provide prod traces later. 

Hopefully once we do PRD-20566 we can improve this even more. 

Thanks to everyone involved here

================================================================================

[APP-47817] Spread quoter: support app pooling for child hedges Created: 2025-08-15  Updated: 2026-01-02
Status:	In Progress
Project:	APP
Component/s:	Spread quoter - family
Fix Version/s:	Tbricks 2.32

Type:	Performance improvement	Priority:	Major
Reporter:	Stepan Edamenko	Assignee:	Anton El'kin
Labels:	madura_perf

Issue Links:
Dependency
is blocked by	TST-120864	Spread quoter: setup performance test	Open
Implementation
implements	PRD-20950	Spread quoter: introduce app pooling for child hedges	In Progress
Relation
is related to	APP-47219	SQ: Slow hedging/+Order creation	Closed

Comments
Comment by Anton El'kin [ 2025-08-15 ]
Opened [PR|https://stash.orcsoftware.com/projects/TB/repos/apps/pull-requests/25847/overview] with async creation for PO and MMO.
The app won't create the Basket order app asynchronously due to the app reuses single instance of the basket order app for hedging.

================================================================================

[APP-48406] OM: Minion parameters should have own cache with CP defs Created: 2025-11-12  Updated: 2025-12-05
Status:	Open
Project:	APP
Component/s:	Basket order, Greeks order, Ladder, Market Making, Order minion, Volatility order
Affects Version/s:	Tbricks 2.21

Type:	Performance improvement	Priority:	Major
Reporter:	Anton El'kin	Assignee:	team_apps_spb

Issue Links:
Relation
is related to	APP-47219	SQ: Slow hedging/+Order creation	Closed
is related to	TB-137261	C++ API: CalculatedPropertyDefinition provides all properties for the particular app	Open

Description
According this APP-47219, GetAllDefinitions takes too much time for execution. It would be nice to not spend milliseconds for getting all definitions even for opening a panel.
We need to have own CP cache on the app level.

Here is the list of classes that are inherited from MinionParameters and might be affected:
* BasketParameters
* MarketMakingParameters
* VOMinionParameters
* LadderMinionParameters

I created this issue for future investigation.

Comments
Comment by Anton El'kin [ 2025-11-12 ]
[~joakimg] and [~artem.kirillov], please, add you input if you have something to add.
Comment by Joakim Gerth [ 2025-11-12 ]
Wouldn't it be better to get support in engine for this ?
Comment by Artem Kirillov [ 2025-11-12 ]
Yeah, it seems more like a workaround for the insufficient API to resolve cp def from param def (although, I'm not sure if this mapping is always unambiguous like cp def -> param def).

It would be somewhat acceptable if there were no substitutions (not only in children classes mentioned, but also in the {{MinionParameters}} itself) which would require extra cp definitions specification in all the apps that use their substitutions. Would look ugly. And very much bug-prone unless there's some extra validation right in constructor (that's not even possible to perform compile-time).
Comment by Anton El'kin [ 2025-11-13 ]
My view is the next:
* The core developers won't improve GetAllDefinitions due to lack of capacity. That's my main concern.
* These classes already have overrides for GetDefinitions, therefore, I don't see a problem having the same for CP. Anyway the app knows all definitions that it uses, so there is no extra cp should be added, they are already in the app metadata or shared/system.
* Indeed, this is a workaround, but having ~10ms delay is quite strange even for opening panels. While we can improve it easily. 

I will discuses it with [~rk].
Comment by Konstantin Romanov [ 2025-11-19 ]
Let's solve it in apps; indeed, an app knows its definitions and can handle it more efficiently.
Comment by Joakim Gerth [ 2025-11-20 ]
{quote}an app knows its definitions and can handle it more efficiently.
{quote}
[~rk], is that always the case ?
Usage of {{CalculatedPropertyDefinition::GetAllDefinitions}} is not limited to order minion. Why wouldn't it be better to cache this mapping in engine and allow app to ask for it when needed ?
Comment by Anton El'kin [ 2025-12-05 ]
Seems we can get what we want in TB-137261. List of definitions is required for the new ladder(app template configuration) to be able to create any order-like strategy.

================================================================================

[PRD-20566] Spread quoter: introduce app pooling for child hedges Created: 2025-10-07  Updated: 2025-11-11
Status:	Product Change Assessment
Project:	PRD
Component/s:	Principal Trading - ETF / Delta 1
Affects Version/s:	Tbricks 2.32

Type:	Enhancement
Reporter:	Stepan Edamenko	Assignee:	Bianca Gabrian
Labels:	madura_perf

Issue Links:
Implementation
implemented in	PRD-20950	Spread quoter: introduce app pooling for child hedges	In Progress
Relation
is related to	APP-47219	SQ: Slow hedging/+Order creation	Closed

Description
h2. Issue Overview

*Specific Problem:*  
The current process creates child hedge applications dynamically at runtime, resulting in execution delays that can lead to unfavorable hedge pricing or missed hedge opportunities.

*Current Behavior:*  
Child hedge apps are created on the fly

h2. Impact Assessment

*Who/What is Affected:*  
Tbricks

*Evidence/Supporting Information:*  
APP-47219

Comments
Comment by Felicia Sussman [ 2025-10-07 ]
[~rk] adding you for transparency
[~stepane] approved tomove forward
Comment by Damien Bishop [ 2025-11-07 ]
[~stepane], this is still unscheduled. We have found an old regression and improved a couple ms in APP-47219 but we still need this case as soon as possible. Would it still be possible in 2.32?
Thanks!
Comment by Stepan Edamenko [ 2025-11-07 ]
It should be converted into product change by the PM first, I'm waiting for it.
Comment by Damien Bishop [ 2025-11-07 ]
[~bgabrian]  I undertand you're the PM here, can we have this  approved/scheduled please?
Comment by Felicia Sussman [ 2025-11-07 ]
Bianca if it is ok to proceed, please select the create product change button
Comment by Bianca Gabrian [ 2025-11-11 ]
Created [PRD-20950] Spread quoter: introduce app pooling for child hedges - Itiviti JIRA. [~felicia.sussman] please approve. Apologies for the delay.

================================================================================

[PRD-20950] Spread quoter: introduce app pooling for child hedges Created: 2025-11-11  Updated: 2025-12-01
Status:	In Progress
Project:	PRD
Component/s:	Principal Trading - ETF / Delta 1
Fix Version/s:	Tbricks 2.32

Type:	Product Change
Reporter:	Bianca Gabrian	Assignee:	Bianca Gabrian

Issue Links:
Implementation
implemented in	APP-47817	Spread quoter: support app pooling for child hedges	In Progress
implements	PRD-20566	Spread quoter: introduce app pooling for child hedges	Product Change Assessment
Tested
tested in	TST-123513	Verification of PRD-20950 (Spread quoter: introduce app pooling for child hedges)	Open

Description
*Specific Problem:*
The current process creates child hedge applications dynamically at runtime, resulting in execution delays that can lead to unfavorable hedge pricing or missed hedge opportunities.

*Current Behavior:*
Child hedge apps are created on the fly

*Who/What is Affected:*
Tbricks

*Evidence/Supporting Information:*
APP-47219

Comments
Comment by Bianca Gabrian [ 2025-11-13 ]
[~felicia.sussman] can you help us with the approval?
Comment by Stepan Edamenko [ 2025-11-14 ]
[~bgabrian], let's schedule for 2.32.
Comment by Bianca Gabrian [ 2025-11-14 ]
Set for 2.32. Thank you for your help!

================================================================================

[SERV-372938] Madura: Slippage Created: 2025-05-13  Updated: 2025-08-15  Resolved: 2025-07-04
Status:	Resolved
Project:	SERV

Type:	Customer Delivery	Priority:	Major
Reporter:	Harshad Hule [X]	Assignee:	Harshad Hule [X]
Resolution:	Fixed
Labels:	Mimosa-Serv

Issue Links:
Relation
is related to	RCA-1041	Order/Quote entry delay leads to halt in Tbricks activity	Open
is related to	APP-47219	SQ: Slow hedging/+Order creation	Closed
is related to	TB-134573	Reactive Markets: Performance issue	Open
is related to	SPRJ-67972	Madura: RM disconnections - Prod prio1	Done
is related to	SPRJ-68164	Madura: DB field mapping cut 	Done

Description
{color:#000000}Hello Fayssal,{color}
{color:#000000}{color}



{color:#000000}
Please join the below link:{color}
{color:#000000}{color}
[https://teams.microsoft.com/l/meetup-join/19%3ameeting_OTAzMWM3ZTgtNjY1Zi00MjA2LTkyMTgtZTM5MGIwNzY1YzQ5%40thread.v2/0?context=%7b%22Tid%22%3a%22a3198c8c-0642-4649-849d-daacc3298f83%22%2c%22Oid%22%3a%229e6dcbe5-d45a-43ac-bbd4-0e13da16ae6b%22%7d|https://teams.microsoft.com/l/meetup-join/19%3ameeting_OTAzMWM3ZTgtNjY1Zi00MjA2LTkyMTgtZTM5MGIwNzY1YzQ5%40thread.v2/0?context=%7b%22Tid%22%3a%22a3198c8c-0642-4649-849d-daacc3298f83%22%2c%22Oid%22%3a%229e6dcbe5-d45a-43ac-bbd4-0e13da16ae6b%22%7d]{color:#000000}{color}
{color:#000000}{color}



{color:inherit}
{color}{color:#000000}{color}


{color:inherit}
{color}{color:#ffffff}

Comments
Comment by Silvia Tancredi [ 2025-05-15 ]
Adding the team


 


 *{color:black} *Silvia Tancredi*{color}*


{color:black}Project Manager EMEA| Trading Solutions Delivery| Broadridge Financial Solutions{color}{color:#500050}{color}


{color:black}London, UK

 *email*:{color} [{color:black}{color}{color:blue}silvia.tancredi@broadridge.com{color}{color:black}{color}|mailto:silvia.tancredi@broadridge.com]{color:black}{color}{color:#500050}{color}{color:black}{color}



{color:black}{color}{color:#1155CC}{color}!image003.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://www.linkedin.com/company/broadridge-financial-solutions/]>{color}{color:black}{color}{color:#1155CC}{color}!image004.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://twitter.com/Broadridge]>{color}{color:black}{color}{color:#1155CC}{color}!image005.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://www.youtube.com/c/broadridge]>{color}{color:black}{color}{color:#1155CC}{color}!image006.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://www.facebook.com/BroadridgeCareers]>{color}{color:#500050}{color}{color:black}{color}


[{color:black}{color}{color:black}Broadridge.com{color}{color:black}{color}|http://broadridge.com/]{color:black}{color}
Comment by Silvia Tancredi [ 2025-05-15 ]
Hi Fayssal,


 


We are working on different fronts in parallel to improve the latency of your system and reduce the slippage significantly. We believe the setting on the RM Tbricks component applied
 yesterday is not the cause of the problem.


The limits rejection problem you reported, and the high slippage are interlaced, and we can solve them both by solving the root problem. This is treated with top priority as a Production
 Bloker and Infrastructure management is involved too.


 


We will provide you with an update by the end of the day, Thanks for your help and the information provided.


 


Kind regards



 



 *{color:black} *Silvia Tancredi*{color}*


{color:black}Project Manager EMEA| Trading Solutions Delivery| Broadridge Financial Solutions{color}{color:#500050}{color}


{color:black}London, UK

 *email*:{color}{color:black}{color} [{color:black}{color}{color:blue}silvia.tancredi@broadridge.com{color}{color:black}{color}|mailto:silvia.tancredi@broadridge.com]{color:black}{color}{color:#500050}{color}{color:black}{color}



{color:black}{color}{color:#1155CC}{color}!image001.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://www.linkedin.com/company/broadridge-financial-solutions/]>{color}{color:black}{color}{color:#1155CC}{color}!image002.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://twitter.com/Broadridge]>{color}{color:black}{color}{color:#1155CC}{color}!image003.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://www.youtube.com/c/broadridge]>{color}{color:black}{color}{color:#1155CC}{color}!image004.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://www.facebook.com/BroadridgeCareers]>{color}{color:#500050}{color}


[{color:black}Broadridge.com{color}|http://broadridge.com/]
Comment by Fayssal  Kabab [ 2025-05-15 ]
{color:#ffffff}Hello Silvia, Thanks for your update and looking forward. Please let me know if you need my help. I am also attaching Reactive Markets investigation on unfilled I&C orders : the total latency on their side is 250μ / 0. 25ms. Thanks, Fayssal{color}




{color:#ffffff}ZjQcmQRYFpfptBannerStart{color}




 
 
 {color:#000000 !important}
 This Message Is From an External Sender{color}
 
 {color:#000000 !important}
This message came from outside your organization.{color}
 

 

 
 
 



{color:#ffffff}ZjQcmQRYFpfptBannerEnd{color}

















Hello Silvia,


Thanks for your update and looking forward. Please let me know if you need my help. I am also attaching Reactive Markets investigation on unfilled
 I&C orders : the total latency on their side is 250μ / 0.25ms.


Thanks,

Fayssal
Comment by Fayssal  Kabab [ 2025-05-15 ]
Renamed attached file: 'Re: First feedback' to 'Re_ First feedback' because it contained invalid character(s).
Comment by Fayssal  Kabab [ 2025-05-16 ]
{color:#ffffff}Good morning, Silvia, I will wait for your green light before re-testing the platform. Thanks, Fayssal From: Fayssal Kabab Sent: Thursday, May 15, 2025 1: 07 PM To: Tancredi, Silvia <Silvia. Tancredi@ broadridge. com>; Hule, Harshad <Harshad. Hule@ broadridge. com>;{color}




{color:#ffffff}ZjQcmQRYFpfptBannerStart{color}




 
 
 {color:#000000 !important}
 This Message Is From an External Sender{color}
 
 {color:#000000 !important}
This message came from outside your organization.{color}
 

 

 
 
 



{color:#ffffff}ZjQcmQRYFpfptBannerEnd{color}

















Good morning, Silvia,


I will wait for your green light before re-testing the platform.


Thanks,

Fayssal
Comment by Silvia Tancredi [ 2025-05-19 ]
Hi Fayssal,


Despite on the weekend a network change was performed by our infrastructure team and Reactive Market, we still detected a problem this morning so we are still investigating the problem
 with the highest priority.


 


Kind regards



 


 *{color:black} *Silvia Tancredi*{color}*


{color:black}Project Manager EMEA| Trading Solutions Delivery| Broadridge Financial Solutions{color}{color:#500050}{color}


{color:black}London, UK

 *email*:{color} [{color:black}{color}{color:blue}silvia.tancredi@broadridge.com{color}{color:black}{color}|mailto:silvia.tancredi@broadridge.com]{color:black}{color}{color:#500050}{color}{color:black}{color}



{color:black}{color}{color:#1155CC}{color}!image011.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://www.linkedin.com/company/broadridge-financial-solutions/]>{color}{color:black}{color}{color:#1155CC}{color}!image012.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://twitter.com/Broadridge]>{color}{color:black}{color}{color:#1155CC}{color}!image013.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://www.youtube.com/c/broadridge]>{color}{color:black}{color}{color:#1155CC}{color}!image014.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://www.facebook.com/BroadridgeCareers]>{color}{color:#500050}{color}{color:black}{color}


[{color:black}{color}{color:black}Broadridge.com{color}{color:black}{color}|http://broadridge.com/]{color:black}{color}
Comment by Fayssal  Kabab [ 2025-05-19 ]
{color:#ffffff}Hi Silvia, Thanks for the update. Can we have a quick call to discuss it ? Thanks, Fayssal From: Tancredi, Silvia <Silvia. Tancredi@ broadridge. com> Sent: Monday, 19 May 2025 11: 32 am To: Fayssal Kabab <fayssal. kabab@ brahman. sg>; Hule,{color}




{color:#ffffff}ZjQcmQRYFpfptBannerStart{color}




 
 
 {color:#000000 !important}
 This Message Is From an External Sender{color}
 
 {color:#000000 !important}
This message came from outside your organization.{color}
 

 

 
 
 



{color:#ffffff}ZjQcmQRYFpfptBannerEnd{color}

















Hi Silvia,


Thanks for the update. Can we have a quick call to discuss it ?



Thanks,

Fayssal
Comment by Silvia Tancredi [ 2025-05-19 ]
{color:#242424}{color}[{color:#242424}{color}{color:#5B5FC7} * Join*
 *the meeting now*{color}{color:#242424} {color}|https://teams.microsoft.com/l/meetup-join/19%3ameeting_OGI0MzQ5ODctYjI5OS00OWNkLWE4YTYtNmE3OTIyNTEyMmUx%40thread.v2/0?context=%7b%22Tid%22%3a%22a3198c8c-0642-4649-849d-daacc3298f83%22%2c%22Oid%22%3a%22f6ee3065-4bfe-4412-af63-850f95352973%22%7d]{color:#242424}{color}


 


 *{color:black} *Silvia Tancredi*{color}*


{color:black}Project Manager EMEA| Trading Solutions Delivery| Broadridge Financial Solutions{color}{color:#500050}{color}


{color:black}London, UK

 *email*:{color} [{color:black}{color}{color:blue}silvia.tancredi@broadridge.com{color}{color:black}{color}|mailto:silvia.tancredi@broadridge.com]{color:black}{color}{color:#500050}{color}{color:black}{color}



{color:black}{color}{color:#1155CC}{color}!image001.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://www.linkedin.com/company/broadridge-financial-solutions/]>{color}{color:black}{color}{color:#1155CC}{color}!image002.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://twitter.com/Broadridge]>{color}{color:black}{color}{color:#1155CC}{color}!image004.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://www.youtube.com/c/broadridge]>{color}{color:black}{color}{color:#1155CC}{color}!image011.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://www.facebook.com/BroadridgeCareers]>{color}{color:#500050}{color}{color:black}{color}


[{color:black}{color}{color:black}Broadridge.com{color}{color:black}{color}|http://broadridge.com/]{color:black}{color}
Comment by Fayssal  Kabab [ 2025-05-21 ]
{color:#ffffff}Good morning Silvia, Can we have a quick call to discuss the ongoing investigations ? (RM network packet losses, RM market data depth, Quanthouse checks) Thank you Fayssal De : Tancredi, Silvia <Silvia. Tancredi@ broadridge. com> Envoyé :{color}




{color:#ffffff}ZjQcmQRYFpfptBannerStart{color}




 
 
 {color:#000000 !important}
 This Message Is From an External Sender{color}
 
 {color:#000000 !important}
This message came from outside your organization.{color}
 

 

 
 
 



{color:#ffffff}ZjQcmQRYFpfptBannerEnd{color}













Good morning Silvia,

Can we have a quick call to discuss the ongoing investigations ? (RM network packet losses, RM market data depth, Quanthouse checks)

Thank you

Fayssal
Comment by Silvia Tancredi [ 2025-05-21 ]
Sure,


I sent you the invite for a meeting in 10 minutes


 


 *{color:black} *Silvia Tancredi*{color}*


{color:black}Project Manager EMEA| Trading Solutions Delivery| Broadridge Financial Solutions{color}{color:#500050}{color}


{color:black}London, UK

 *email*:{color} [{color:black}{color}{color:blue}silvia.tancredi@broadridge.com{color}{color:black}{color}|mailto:silvia.tancredi@broadridge.com]{color:black}{color}{color:#500050}{color}{color:black}{color}



{color:black}{color}{color:#1155CC}{color}!image001.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://www.linkedin.com/company/broadridge-financial-solutions/]>{color}{color:black}{color}{color:#1155CC}{color}!image002.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://twitter.com/Broadridge]>{color}{color:black}{color}{color:#1155CC}{color}!image003.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://www.youtube.com/c/broadridge]>{color}{color:black}{color}{color:#1155CC}{color}!image004.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://www.facebook.com/BroadridgeCareers]>{color}{color:#500050}{color}{color:black}{color}


[{color:black}{color}{color:black}Broadridge.com{color}{color:black}{color}|http://broadridge.com/]{color:black}{color}
Comment by Fayssal  Kabab [ 2025-05-21 ]
{color:#ffffff}Hi team, Thanks for the call this morning and all the changes made ( (a) Network firewall (b) Computer network card config (c) previously quoted order information removed (d) limit the market data depth to 10 first levels) I’m going to test{color}




{color:#ffffff}ZjQcmQRYFpfptBannerStart{color}




 
 
 {color:#000000 !important}
 This Message Is From an External Sender{color}
 
 {color:#000000 !important}
This message came from outside your organization.{color}
 

 

 
 
 



{color:#ffffff}ZjQcmQRYFpfptBannerEnd{color}

















Hi team,


Thanks for the call this morning and all the changes made ( (a) Network firewall (b) Computer network card config (c) previously quoted order information
 removed (d) limit the market data depth to 10 first levels)


I’m going to test trade today. Could you please kindly investigate the below unfilled I&C order outlier where the latency is 11ms and 33ms vs others
 at 1ms ?


Thanks,

Fayssal


 


 


Order identifier Created Modified             Side       Instrument         Price      Total #  Filled #  Active # Portfolio


33f41798-3628-11f0-8590-575ff85cf4d0                 Today 11:44:34.671am   Today 11:44:34.682am   Buy        XAUUSD SPOT     3307.96                
 0              0              0              00114


 
|{color:black}1689f556-3628-11f0-8590-575ff85cf4d0{color}|{color:black}Today 11:43:45.321am{color}|{color:black}Today 11:43:45.354am{color}|{color:black}Buy{color}|{color:black}XAUUSD SPOT{color}|{color:black}3308.18{color}|{color:black}0{color}|{color:black}0{color}|{color:black}0{color}|{color:black}114{color}|{color:black}fayssal{color}|{color:black}Completed{color}|{color:black}Canceled, reason [cancelled: retry timeout]{color}|
Comment by Damien Bishop [ 2025-05-21 ]
Hi Fayssal,



You’re welcome.



Yes we will have a look at this order. We may need help from RM on this as we aren’t persisting FIX messages on this component for latency reasons but first we’ll check everything within Tbricks




Thanks,
Comment by Fayssal  Kabab [ 2025-05-21 ]
{color:#ffffff}Hi Damien, Great thanks. I’ve completed 52 deals on live to test and here are the slippages, updated document attached - We can see a very sensible improvement between last time and today : from 0. 1115$ avg to 0. 0571$. I’m attaching below my{color}




{color:#ffffff}ZjQcmQRYFpfptBannerStart{color}




 
 
 {color:#000000 !important}
 This Message Is From an External Sender{color}
 
 {color:#000000 !important}
This message came from outside your organization.{color}
 

 

 
 
 



{color:#ffffff}ZjQcmQRYFpfptBannerEnd{color}

















Hi Damien,


Great thanks. I’ve completed 52 deals on live to test and here are the slippages, updated document attached - We can see a very sensible improvement
 between last time and today : from 0.1115$ avg to 0.0571$. 


I’m attaching below my current system slippages - This is over a large sample (tens of thousands of deals) but give us an idea of what would the
 target to match our existing setup.


I’m also listing the ideas discussed :
* Investigate unfilled I&C orders high latency with RM
* Sanity check Quanthouse market data (network, latency)
* Reduce more the RM market data levels to 5 (from 10) as we’re trading only 500oz and our
 LPs are showing us 100oz TOB minimum
*  



I will keep doing some test trades so we have more data to analyse and see if it converts to our ~0 average target.


Thanks very much


Fayssal


 


 


 *+First day+*


!image007.png|thumbnail!


 


 *+21th May after the following changes (firewall, network card, market data subscription remove forex, market data subscription limit to 10 first+*
 *+limits)+*


 


!image009.png|thumbnail!


 *+Legacy system slippages+*
 


 


!image010.png|thumbnail!
Comment by Fayssal  Kabab [ 2025-05-22 ]
{color:#ffffff}Good morning team, I’ve pushed some flows this morning to have more analytics (300+ deals). The manual processing of slippages will take too much time so I’ll stop trading for the moment and I’ll try automate it today. On a first look it’s still{color}




{color:#ffffff}ZjQcmQRYFpfptBannerStart{color}




 
 
 {color:#000000 !important}
 This Message Is From an External Sender{color}
 
 {color:#000000 !important}
This message came from outside your organization.{color}
 

 

 
 
 



{color:#ffffff}ZjQcmQRYFpfptBannerEnd{color}

















Good morning team,


I’ve pushed some flows this morning to have more analytics (300+ deals). The manual processing of slippages will take too much time so I’ll stop
 trading for the moment and I’ll try automate it today. On a first look it’s still a bit too high and around yesterday level with an average at 0.0716$ per oz, $2391 total.


Thanks,


Fayssal
Comment by Fayssal  Kabab [ 2025-05-22 ]
{color:#ffffff}Good evening team, I’ve finished scripting slippages reports; here are the results for today. Today was a quite volatile session so we had some outliers that are most probably future market data related. Would it be possible to study the latency{color}




{color:#ffffff}ZjQcmQRYFpfptBannerStart{color}




 
 
 {color:#000000 !important}
 This Message Is From an External Sender{color}
 
 {color:#000000 !important}
This message came from outside your organization.{color}
 

 

 
 
 



{color:#ffffff}ZjQcmQRYFpfptBannerEnd{color}

















Good evening team,


I’ve finished scripting slippages reports; here are the results for today. Today was a quite volatile session so we had some outliers that are most probably future market data
 related. Would it be possible to study the latency of each “hop” on the following example ? (timestamps of quanthouse market data update, tbricks order generations to rm, rm processing and then db fut hedging). Target price sell $1.50, executed price -0.52$,
 slippage 2.02$.


Thanks,


Fayssal


 
|{color:#9C0006}Today 10:31:05.304am{color}|{color:#9C0006}Automatic{color}|{color:#9C0006}Buy{color}|{color:#9C0006}XAUUSD SPOT{color}|{color:#9C0006}100{color}|{color:#9C0006}3313.02{color}|{color:#9C0006}USD{color}|{color:#9C0006}114{color}|{color:#9C0006}XTXM{color}|{color:#9C0006}0BBZ4DV70NJ77{color}|{color:#9C0006}fayssal{color}|{color:#9C0006}Reactive FX{color}|{color:#9C0006}078c2c02-36cf-11f0-b149-be84e16cd6ae{color}|
|{color:#9C0006}Today 10:31:05.357am{color}|{color:#9C0006}Automatic{color}|{color:#9C0006}Sell{color}|{color:#9C0006}GC Jun-25 F{color}|{color:#9C0006}1{color}|{color:#9C0006}3312.5{color}|{color:#9C0006}USD{color}|{color:#9C0006}114{color}|{color:#9C0006} {color}|{color:#9C0006}P95Wc2LhBbhRhLw_{color}|{color:#9C0006}fayssal{color}|{color:#9C0006}DeutscheBank{color}|{color:#9C0006}078c2c02-36cf-11f0-b149-be84e16cd6ae{color}|



 


 


!image019.png|thumbnail!


!image020.png|thumbnail!
Comment by Damien Bishop [ 2025-05-23 ]
Hi,




Will take a look at this.



Thanks,
Comment by Damien Bishop [ 2025-05-23 ]
Hi Fayssal,



I’ll comment on each request one by one;



timestamps of quanthouse market data update

{color:#4E95D9}I’ve spoken internally to engineering and this is not something that we are going to be able to accurately track ourselves. Engineerings first comment is
 one that I’m sure you’re aware of but I will say it anyway. Generally QH as an aggregator is not ideal in a latency sensitive set up, from their experience QH can often introduce large delays in MD.




In terms of exchange timestamps using FeedOS we do not have this information in the same way it sounds like their FIX market data provider did have. I think the only real way to know for sure the wire time and our processing time would be for QH to look at
 or send us a small PCAP where we can see how long it takes from them sending data to us acking that packet, I don’t expect this to be a real issue though . Perhaps QH can also help understanding time within their stack, if they have those metrics?{color}




tbricks order generations to rm 

{color:#4E95D9}We wouldn’t be able to provide specific latency from tick to order for this particular order. We’ve been taking internal latency tick to order statistics
 and for today 80% of events were under 1ms and 99.9% of events under 1.4ms. There are some improvements still to be made here which we are testing now.{color}




rm processing

{color:#4E95D9}We don’t have the details on this but I understand you have access to an analytics sweet and can speak to RM directly about this, they have devices that will
 be able to give you/us the exact latency RM and LP side.{color} 





db fut hedging

{color:#4E95D9}On this particular order DB looked to be a little slower here, without analyzing too much the exact figures we see RTT from our connection to DB and back
 again are mostly under 30ms total with DB internal time around ~24-25ms. We do see semi regular outliers though for example order Aqu3as4xpk1v had a RTT of 41ms. Of course this is just the hedge and you’re mainly interested in the 1 way latency which we can
 see is generally half of the full RTT. One quirk of DB is its hard to estimate how long it takes from them executing to sending us the FIX message because they only go down to second precision on sending time of their FIX messages. Eg 52=20250523-08:23:38{color}



Please let me know if you need any clarifications.



Thanks,
Comment by Fayssal  Kabab [ 2025-05-23 ]
{color:#ffffff}Hi Damien, Thanks for your very clear comments. re Quanthouse – understood re the Engineering team feedback. The good news is we’re using the exact same infrastructure on our legacy algo (different fix login to the same server) and we’re trying{color}




{color:#ffffff}ZjQcmQRYFpfptBannerStart{color}




 
 
 {color:#000000 !important}
 This Message Is From an External Sender{color}
 
 {color:#000000 !important}
This message came from outside your organization.{color}
 

 

 
 
 



{color:#ffffff}ZjQcmQRYFpfptBannerEnd{color}

















Hi Damien,


Thanks for your very clear comments.
* re Quanthouse – understood re the Engineering team feedback. The good news is we’re using the exact same infrastructure
 on our legacy algo  (different fix login to the same server) and we’re trying to have a similar cost of execution. As our spread strategy is based on the future market data, It would be great to check if there’s no network or software bottleneck on that side
 as well. I can create a thread with our Quanthouse contact and think they will be happy to help, please let me know if you want me to do so.
* Great news re tick to order statistics. We are not trying to arb Spot LPs, we are trying not to get arb by sending a
 stale I&C spot order. I think the most important part will be the Future Market data to I&C spot order generation.
* I will ask RM and share their feedback.
* We discussed this, but I’m quite surprised by the difference between the tbricks latency Market roundtrip monitor and
 DB’s feedback (attached). We see around 30ms where they see a Median of 24ms (in/out time at their FIX engine level).



Thanks,

Fayssal
Comment by Fayssal  Kabab [ 2025-05-23 ]
Renamed attached file: 'RE: Madura UAT - DB connection' to 'RE_ Madura UAT - DB connection' because it contained invalid character(s).
Comment by Damien Bishop [ 2025-05-23 ]
Hi,




Yes please loop me/the team into any thread regarding this with QH. 



For DB. Looking at the orders for today there is 1 order that was under 24ms round trip from us to them and it was 23.5, the rest are (slightly) above with a max of 36.9. The example order you asked me to look at  below had a 41ms RTT. There is some wire time
 here but it should be very minimal.



Thanks,
Comment by Fayssal  Kabab [ 2025-05-23 ]
{color:#ffffff}Hello team, Sharing the “market hedges” slippages analytics for today. Thanks for all the help this week and have a great week end. Thanks, Fayssal From: Bishop, Damien <Damien. Bishop@ broadridge. com> Sent: Friday, May 23, 2025 1: 39 PM{color}




{color:#ffffff}ZjQcmQRYFpfptBannerStart{color}




 
 
 {color:#000000 !important}
 This Message Is From an External Sender{color}
 
 {color:#000000 !important}
This message came from outside your organization.{color}
 

 

 
 
 



{color:#ffffff}ZjQcmQRYFpfptBannerEnd{color}

















Hello team,


Sharing the “market hedges” slippages analytics for today. Thanks for all the help this week and have a great week end.


Thanks,

Fayssal


!image025.png|thumbnail!
Comment by Fayssal  Kabab [ 2025-05-27 ]
{color:#ffffff}Good morning Silvia, Would you be available for a quick follow up call ? Thank you, Fayssal De : Fayssal Kabab <fayssal. kabab@ brahman. sg> Envoyé : vendredi, mai 23, 2025 7: 53 PM À : Bishop, Damien <Damien. Bishop@ broadridge. com>;{color}




{color:#ffffff}ZjQcmQRYFpfptBannerStart{color}




 
 
 {color:#000000 !important}
 This Message Is From an External Sender{color}
 
 {color:#000000 !important}
This message came from outside your organization.{color}
 

 

 
 
 



{color:#ffffff}ZjQcmQRYFpfptBannerEnd{color}













Good morning Silvia,

Would you be available for a quick follow up call ?

Thank you,

Fayssal
Comment by Silvia Tancredi [ 2025-05-27 ]
Hi Fayssal,


Yes sure. We have call scheduled in 1 hour and 15 minutes.



Would that be ok for you?


 


 


 *{color:black} *Silvia Tancredi*{color}*


{color:black}Project Manager EMEA| Trading Solutions Delivery| Broadridge Financial Solutions{color}{color:#500050}{color}


{color:black}London, UK

 *email*:{color} [{color:black}silvia.tancredi@broadridge.com{color}|mailto:silvia.tancredi@broadridge.com]{color:black}{color}{color:#500050}{color}{color:black}{color}



{color:black}{color}{color:#1155CC}{color}!image001.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://www.linkedin.com/company/broadridge-financial-solutions/]>{color}{color:black}{color}{color:#1155CC}{color}!image002.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://twitter.com/Broadridge]>{color}{color:black}{color}{color:#1155CC}{color}!image003.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://www.youtube.com/c/broadridge]>{color}{color:black}{color}{color:#1155CC}{color}!image004.png|thumbnail!{color:#1155CC}{color}{color:black} <[https://www.facebook.com/BroadridgeCareers]>{color}{color:#500050}{color}{color:black}{color}


[{color:black}{color}{color:black}Broadridge.com{color}{color:black}{color}|http://broadridge.com/]{color:black}{color}
Comment by Fayssal  Kabab [ 2025-05-27 ]
{color:#ffffff}Good morning Silvia, That’s perfect thanks ! Thanks, Fayssal From: Tancredi, Silvia <Silvia. Tancredi@ broadridge. com> Sent: Tuesday, 27 May 2025 10: 14 am To: Fayssal Kabab <fayssal. kabab@ brahman. sg>; Bishop, Damien <Damien. Bishop@ broadridge. com>;{color}




{color:#ffffff}ZjQcmQRYFpfptBannerStart{color}




 
 
 {color:#000000 !important}
 This Message Is From an External Sender{color}
 
 {color:#000000 !important}
This message came from outside your organization.{color}
 

 

 
 
 



{color:#ffffff}ZjQcmQRYFpfptBannerEnd{color}

















Good morning Silvia,


That’s perfect thanks !


Thanks,

Fayssal
Comment by Silvia Tancredi [ 2025-05-27 ]
{color:#242424}____ We are all in the call. Are you able to join?{color}

================================================================================

[SPRJ-69051] Plus Order Traces Created: 2025-06-18  Updated: 2025-06-19  Resolved: 2025-06-19
Status:	Done
Project:	SPRJ

Type:	Story	Priority:	Minor
Reporter:	Harshad Hule [X]	Assignee:	Harshad Hule [X]
Resolution:	Done
Labels:	Mimosa

Issue Links:
Relation
is related to	APP-47219	SQ: Slow hedging/+Order creation	Closed

Description
We need to get traces for Plus order app to identify where is it taking time.

Traces were added in the UAT as follows:
{code}
tbricks@se-eqx-madtst01:~
$ tbtrace ls
--------------------------------------------------------------------------------------------
              Session                Created      Status         Template         Entities
--------------------------------------------------------------------------------------------
    plus_order_trace                              Stopped          apps           mdr_uat
    plus_order_trace2                             Stopped          apps           mdr_uat
    plus_order_trace3                             Stopped          apps           mdr_uat
    sq_TEST_tick_to_order                         Stopped      tick_to_order      mdr_uat
    sq_uat_tick_to_order                          Stopped      tick_to_order      mdr_uat
    sq_uat_tick_to_order_no_ioc                   Stopped      tick_to_order      mdr_uat
--------------------------------------------------------------------------------------------
{code}

Traces reported under APP-47219.

Waiting for an update from Dev.

================================================================================

[TB-120981] ParameterDefinition: slowness in CalculatedPropertyDefinition() operator Created: 2022-09-09  Updated: 2025-10-31
Status:	Open
Project:	TB
Component/s:	API/C++ apps
Affects Version/s:	Tbricks 2.19

Type:	Performance improvement	Priority:	Major
Reporter:	Stepan Edamenko	Assignee:	team_tb_core

Issue Links:
Benefits from
benefits to	APP-46679	Bond beta: support make whole call provision	Verified
Relation
is related to	APP-47219	SQ: Slow hedging/+Order creation	Closed
is related to	TB-119593	Reduce lock contention when opening many view models	Closed
is related to	APP-36220	SOR Audit: replace DistributedValues stream by Remote view subscription	Closed

Description
{noformat}
57.62%
     DefinitionBase::operator CalculatedPropertyDefinition
{noformat}

Comments
Comment by Fedor Lisochenko [ 2022-09-09 ]
Bad guess

-We can probably get use of parameter definition which is used in- 
{code:java}
void DefinitionBase::resolve(std::shared_ptr<const protocol::ParameterDefinition> def) const{code}
-to get the mapping id without a need to access the metadata cache.-

-In protocol::ParameterDefinition:-
{code:java}
PROTOCOL_MSG_MEMBER_EXPORT_INL int get_data_mapping_identifier(types::UUID & field_arg) const;
{code}
Comment by Anton El'kin [ 2022-09-09 ]
Here is dump log:

{noformat}
[anton.elkin@elgon TB-120981]$ pwd
/tb/shared/tbricks/JIRA/TB-120981
[anton.elkin@elgon TB-120981]$ ls -lah
total 1.6G
drwxr-xr-x    2 anton.elkin orcgroup 4.0K Sep  9 15:11 .
drwxrwxrwx 7585 nobody      nobody   928K Sep  9 15:14 ..
-rw-r--r--    1 anton.elkin orcgroup 1.6G Sep  9 15:15 ve.log
{noformat}
Comment by Anton El'kin [ 2022-09-09 ]
Parameter that should be in the audit:

{noformat}
/// Strategy parameter "Side", type "Side"
inline tbricks::ParameterDefinition Side()
{
    // Identifier: "1a010a05-ab5b-4c0a-b423-c722392b37e9"
    // Name: "Side"
    // Description: "Indicates if it is a buy or sell side for the object."
    // Type: "Side"
    // Persistence: "Buffered"
    // Direction: "InputOutput"
    tbricks::ParameterDefinition pd(
        std::pair<uint64_t, uint64_t>(0xa4c5bab050a011aULL, 0xe9372b3922c723b4ULL));
    return pd;
}
{noformat}
Comment by Alexander Grigoriev [ 2023-01-03 ]
This call will be expensive in any case, as it needs to resolve calculated property using cache in the engine. It much better to keep a simple cache (Parameters definition to Calculated property) in the app.

But, sure, let's investigate if we can improve this.
Comment by Denis Apelgants [ 2023-01-03 ]
TB-119593 is more interesting in that sense. It seems better to push on various extensions to CalculatedPropertyDefinition, GetAllDefinitions method is not enough, some more getters with predicate to get properties in one go looks better. What do you think?
Comment by Vasiliy Markin [ 2025-10-31 ]
After adding several unrelated new calculated properties in scope of APP-46679, the latency of Basket order and Plus order creation has increased in ETF MM test.
 !etf_mm.png|thumbnail! 

It increased from ~2ms to ~2.4ms when getting calculated properties definitions
{noformat}
HandleConstructor entry - plus_order:get_definitions                                 54      9 µs     12 µs     16 µs     19 µs     19 µs    0.0%     19 µs
  plus_order:get_definitions - plus_order:got_definitions                            54    2.4 ms    2.5 ms    2.6 ms    3.3 ms    3.3 ms    0.0%    3.3 ms
   plus_order:got_definitions - plus_order:enter_constructor                         54     79 µs     86 µs     98 µs    109 µs    109 µs    0.0%    109 µs
{noformat}

apps/shared/order_minion/MinionParameters.h:32
{noformat}
    TRACEPOINT_GLOBAL(get_definitions);
    Definitions defs;
    GetDefinitions(defs);
    m_cpSubstitutions = ValidatorHelper::GetDefinitionsMap(defs);
    TRACEPOINT_GLOBAL(got_definitions);
{noformat}
It should affect some other apps as well (hedgers, fair price order, greeks order..)
Let's try to align and see if requesting only the required properties in the app or caching it in the engine would help making it fast.

================================================================================

[TST-120864] Spread quoter: setup performance test Created: 2025-08-15  Updated: 2025-12-15
Status:	Open
Project:	TST
Component/s:	Performance tests
Fix Version/s:	Tbricks 2.32

Type:	Task	Priority:	Major
Reporter:	Stepan Edamenko	Assignee:	Julia Solennikova

Issue Links:
Dependency
blocks	APP-47817	Spread quoter: support app pooling for child hedges	In Progress

Comments
Comment by Stepan Edamenko [ 2025-08-15 ]
[~yakupovm], could you help?
Comment by Stepan Edamenko [ 2025-09-30 ]
Also, we should configure app pooling (https://itivitinet.itiviti.com/display/TbricksMaster/App+pooling) for child +Orders to measure the impact of APP-47817.
Comment by Julia Solennikova [ 2025-10-07 ]
Ok, perf test for Spread Quoter is done:
 * there are 5 SQ app with a big volume (apps added via App importer app)
 * opportunity orders created by Market Simulator app
 * app pooling was configured (size = 5, extend = 2) and checked with a custom branch

Got ~3k updates in 120 sec

Measurements for child hedge Plus order creations:

SQ 2.32:
{noformat}
(Latency metric strelka 2.31 2a0694dfaff Tue Oct  7 01:03:53 CEST 2025)
=====================================================================================================================================
                                                                      #      50%      80%      95%      99%    99.9%  >2x80%      MAX
=====================================================================================================================================
protocol_out_order:order - protocol_in_order:order                 3146     2 µs     3 µs     4 µs     4 µs     7 µs    0.2%     9 µs
  protocol_in_order:order - pe:handle_order_update_entry           3146     7 µs   138 µs   414 µs   679 µs   917 µs    9.7%   1.1 ms
    pe:handle_order_update_entry - pe:strategy_add_request         3146    18 µs    23 µs    25 µs    29 µs    31 µs    0.0%    32 µs
      pe:strategy_add_request - pe:create_from_pool_entry          3146    15 µs    78 µs   129 µs   168 µs   221 µs    1.7%   262 µs
        pe:create_from_pool_entry - pe:handle_constructor_entry    3146   109 µs   119 µs   127 µs   137 µs   227 µs    0.1%   436 µs
          pe:handle_constructor_entry - pe:open_stream             3146   4.0 ms   4.3 ms   4.5 ms   4.6 ms   4.7 ms    0.0%   4.8 ms
            pe:open_stream - pe:open_stream                       15730    15 µs    91 µs   152 µs   171 µs   200 µs    0.5%   245 µs
              pe:open_stream - pe:order_add_request                3146    28 µs    31 µs    39 µs    46 µs    57 µs    0.0%    60 µs
                pe:order_add_request - tr_fw:received_order_add    3146     3 µs     3 µs     3 µs     5 µs    10 µs    0.3%    10 µs
                  tr_fw:received_order_add - tr_fw:encode_request  3146    19 µs    21 µs    25 µs    30 µs    69 µs    0.4%   154 µs
                    tr_fw:encode_request - tr_fw:send_request      3146    18 µs    19 µs    21 µs    25 µs    29 µs    0.0%    33 µs
                      tr_fw:send_request - tr:send_request         3146     1 µs     1 µs     1 µs     2 µs     5 µs    0.7%     7 µs
-------------------------------------------------------------------------------------------------------------------------------------
Path: protocol_out_order:order - tr:send_request                   3146   4.5 ms   4.8 ms   5.1 ms   5.3 ms   5.7 ms    0.0%   5.9 ms
=====================================================================================================================================
{noformat}
SQ custom with app pooling:
{noformat}
(Latency metric strelka 2.31 2a0694dfaff Tue Oct  7 00:55:21 CEST 2025)
=============================================================================================================================================================
                                                                                            #      50%      80%      95%      99%     99.9%  >2x80%       MAX
=============================================================================================================================================================
protocol_out_order:order - protocol_in_order:order                                       3415     2 µs     3 µs     4 µs     4 µs      7 µs    0.3%     10 µs
  protocol_in_order:order - pe:handle_order_update_entry                                 3415     6 µs    34 µs   349 µs   453 µs    527 µs   16.9%    588 µs
    pe:handle_order_update_entry - pe:strategy_add_request                               3415    18 µs    23 µs    25 µs    29 µs     35 µs    0.0%     43 µs
      pe:strategy_add_request - pe:create_from_pool_entry                                3415   535 µs   1.1 ms   1.7 ms   2.2 ms   11.1 ms    0.9%   13.7 ms
        pe:create_from_pool_entry - pe:create_from_pool_success_exit                     3415     4 µs     4 µs     5 µs     6 µs     12 µs    0.5%     14 µs
          pe:create_from_pool_success_exit - pe:handle_execute_pool_modify_entry         3415     1 µs     2 µs     2 µs     2 µs      9 µs    0.4%   11.7 ms
            pe:handle_execute_pool_modify_entry - pe:handle_modify_request_entry         3415     3 µs     3 µs     3 µs     4 µs     10 µs    0.6%     12 µs
              pe:handle_modify_request_entry - pe:open_stream                            3415   107 µs   118 µs   125 µs   133 µs    139 µs    0.0%    174 µs
                pe:open_stream - pe:open_stream                                          3415    22 µs    23 µs    27 µs    30 µs     37 µs    0.0%     38 µs
                  pe:open_stream - pe:handle_modify_request_exit                         3415    14 µs    14 µs    19 µs    22 µs     28 µs    0.1%     32 µs
                    pe:handle_modify_request_exit - pe:handle_run_request_entry          3415     1 µs     1 µs     1 µs     1 µs      6 µs    0.1%      8 µs
                      pe:handle_run_request_entry - pe:order_add_request                 3415    16 µs    17 µs    18 µs    24 µs     26 µs    0.0%     29 µs
                        pe:order_add_request - protocol_out_order_entry:order            3415     4 µs     4 µs     5 µs     6 µs     11 µs    0.6%     17 µs
                          protocol_out_order_entry:order - protocol_in_order_entry:order 3415     3 µs     3 µs     3 µs     3 µs     10 µs    0.5%     11 µs
                            protocol_in_order_entry:order - tr_fw:received_order_add     3415     2 µs     2 µs     2 µs     3 µs      9 µs    0.6%     10 µs
                              tr_fw:received_order_add - tr_fw:encode_request            3415    18 µs    19 µs    23 µs    25 µs    217 µs    0.4%    416 µs
                                tr_fw:encode_request - tr_fw:send_request                3415    17 µs    18 µs    19 µs    24 µs     26 µs    0.0%     27 µs
                                  tr_fw:send_request - tr:send_request                   3415     1 µs     1 µs     2 µs     2 µs      7 µs    0.6%     17 µs
-------------------------------------------------------------------------------------------------------------------------------------------------------------
Path: protocol_out_order:order - tr:send_request                                         3415   823 µs   1.4 ms   2.0 ms   2.6 ms   11.6 ms    0.6%   14.0 ms
============================================================================================================================================================={noformat}
Test: [https://bamboo.orcsoftware.com/browse/APTE-SQ0-27|https://bamboo.orcsoftware.com/browse/APTE-SQ0-31]
Comment by Julia Solennikova [ 2025-10-16 ]
Discussed to change test set up, so:
 * Added 1000 Spread Quoter apps with less Hedge child apps (4-5 per app)
 * Added 1000 Order apps via App importer app

(!) *And issue with stream stale appeared, not possible to get any measurement* 
 Investigation is in progress:
 * Added python script to reduce amount of apps by variable in bamboo
[WIP]
Comment by Julia Solennikova [ 2025-10-20 ]
Ok, I moved test to load nodes (alberts) and reduced number of apps to 100, but still receive strategy stream stale and couldn't get any results.
 I collect dump for 2 minutes, it's pretty big, but I hope will be helpful..) 
{noformat}
[20/10 13:55:32] bamboo@albert-1 ~> ls -lh
total 37G
-rwxrwxrwx 1 bamboo tbeng 36G Oct 20 13:55 sc.dump.log
/tb/shared/tbricks/JIRA/TST-120864{noformat}
[~anton.elkin], as Stepan is on vacation, could you check, please?
Comment by Julia Solennikova [ 2025-12-04 ]
Re-setup the test to use Wave order app instead of Market Simulator to decrease the load.
The problem with strategy stream stale is still reproduced. 
{noformat}
2025-12-03 15:37:56.165481 CET albert-2.orcsoftware.com al2_wed_sq_sc@perf_albert_2_LOAD_SQ0_wed_sys/al2_wed_sq_sc@perf_albert_2_LOAD_SQ0_wed_sys[412171:0x7fff533ff700] protocol <warning> src/IService.cpp(103):Session timeout for al2_wed_sq_sc@perf_albert_2_LOAD_SQ0_wed_sys [local 127.0.0.1:59259], closing connection (15 sec).
                                                                                                                                                                                                         <action>:Contact Itiviti support
                                                                                                                                                                                                            <see>:https://portal.orc-group.com/confluence/display/Tbricks232/TB-0090
2025-12-03 15:37:56.165492 CET albert-2.orcsoftware.com al2_wed_sq_sc@perf_albert_2_LOAD_SQ0_wed_sys/al2_wed_sq_sc@perf_albert_2_LOAD_SQ0_wed_sys[412171:0x7fff533ff700] transport.sio <debug> src/SOCK_Transport.cpp(426): 0x7fff53523430: SOCK_SvcHandler::close_connection(): al2_wed_sq_sc@perf_albert_2_LOAD_SQ0_wed_sys [local 127.0.0.1:59259] softClose=0
2025-12-03 15:37:56.165534 CET albert-2.orcsoftware.com al2_wed_sq_sc@perf_albert_2_LOAD_SQ0_wed_sys/al2_wed_sq_sc@perf_albert_2_LOAD_SQ0_wed_sys[412171:0x7fff533ff700] transport.sio <debug> src/SOCK_Transport.cpp(306): 0x7fff53523430: SOCK_SvcHandler::handle_close(): al2_wed_sq_sc@perf_albert_2_LOAD_SQ0_wed_sys [local 127.0.0.1:59259] closeMask=493
2025-12-03 15:37:56.165535 CET albert-2.orcsoftware.com al2_wed_sq_sc@perf_albert_2_LOAD_SQ0_wed_sys/al2_wed_sq_sc@perf_albert_2_LOAD_SQ0_wed_sys[412171:0x7fff533ff700] transport <debug> src/Application.cpp(1373): Erase SvcHandler[0x7fff53523430] al2_wed_sq_sc@perf_albert_2_LOAD_SQ0_wed_sys [local 127.0.0.1:59259]
2025-12-03 15:37:56.165558 CET albert-2.orcsoftware.com al2_wed_sq_sc@perf_albert_2_LOAD_SQ0_wed_sys/al2_wed_sq_sc@perf_albert_2_LOAD_SQ0_wed_sys[412171:0x7fff533ff700] protocol <warning> src/IService.cpp(111):Session timeout for al2_wed_sq_se-se@perf_albert_2_LOAD_SQ0_wed_sys [local 127.0.0.1:38981] (10 sec).

2025-12-03 15:37:56.165637 CET albert-2.orcsoftware.com al2_wed_sq_sc@perf_albert_2_LOAD_SQ0_wed_sys/al2_wed_sq_sc@perf_albert_2_LOAD_SQ0_wed_sys[412171:0x7fffdddf0700] se.services <debug> src/InternalSubscriptionCache.cpp(100): Update Service
<message> (609) Service, <size> [304]
{
  component identifier = <uuid> d312e59a-d054-11f0-a280-1d9ea016ddeb
  component name = <string> "al2_wed_sq_se"
  connected = <boolean> false
  disabled = <boolean> false
  downtime = <boolean> false
  host name = <string> "albert-2.orcsoftware.com"
  ip address = <string> "127.0.0.1:38981"
  service class = <uint32> 7
  service identifier = <uuid> al2_wed_sq_se-se (d312e5f4-d054-11f0-a280-1d9ea016ddeb)
  service name = <string> "al2_wed_sq_se-se"
  service state = <service state> Online
  service type = <string> "StrategyEngine"
  status = <status> Fail
  stream item identifier = <uuid> al2_wed_sq_se-se (d312e5f4-d054-11f0-a280-1d9ea016ddeb)
  subsystem identifier = <uuid> cfc38610-d054-11f0-a280-1d9ea016ddeb
  subsystem name = <string> "default"
  system identifier = <uuid> cfc3850c-d054-11f0-a280-1d9ea016ddeb
  system name = <string> "perf_albert_2_LOAD_SQ0_wed_sys"
  venue identifier = <uuid> <empty>
}
2025-12-03 15:37:56.165677 CET albert-2.orcsoftware.com al2_wed_sq_sc@perf_albert_2_LOAD_SQ0_wed_sys/al2_wed_sq_sc@perf_albert_2_LOAD_SQ0_wed_sys[412171:0x7fffea1fd700] plugin <warning> ./OrderMinionChildPluginProcessor.h(39): OrderMinion Trailing stop processor: child strategy stream is stale [plugin 8f94bd74-d055-11f0-b570-8706c863bbaa] [plugin.ancestors_id <empty>] [plugin.creator ] [plugin.name ABC   300228C9.00 TR (XMOD) HEDGE (XMOD)-2ABC   300228C9.50 TR (XMOD) HEDGE (XMOD) (buy)] [plugin.owner tbricks] [plugin.owner_id 5522d422-2f9e-11e5-bf70-ed884eb26bba] [plugin.parent_id 8f94bd74-d055-11f0-b570-8706c863bbaa] [plugin.root_id 8f94bd74-d055-11f0-b570-8706c863bbaa] [plugin.type Spread quoter] [plugin.type_id 3f4e9e24-549d-11e4-bcdb-d6ae529049f1]

{noformat}
No useful information in aa, ac, dc logs, also checked _var/log/messages_
Tried to reproduce manually - it's perfectly fine with all 1000 apps.

[~stepane], [~anton.elkin], [~vasiliy.markin], what can I check to fix the problem? Something went wrong at the start of tracing.
SC load is not more than ~20G
Collected dump to investigate the issue, reproduced without persisted dump.
Logs:
{noformat}
[03/12 17:40:29] bamboo@albert-2 ~> ls -lh sc_wo.dump
-rwxrwxrwx 1 bamboo tbeng 7.2G Dec  3 17:39 sc_wo.dump
/tb/shared/tbricks/JIRA/TST-120864
{noformat}
Comment by Julia Solennikova [ 2025-12-04 ]
Stale occurred at 4:47:51.451PM
Added stacks and samples:
{noformat}
[04/12 17:09:55] bamboo@albert-3 ~> ls -lh samples
total 3.1M
-rw-r--r-- 1 bamboo tbeng 1.1M Dec  4 17:05 tbsample_al3_thu_sq_sc_albert-3_20251204-164726
-rw-r--r-- 1 bamboo tbeng  36K Dec  4 17:05 tbsample_al3_thu_sq_sc_albert-3_20251204-164726.graph
-rw-r--r-- 1 bamboo tbeng 371K Dec  4 17:05 tbsample_al3_thu_sq_sc_albert-3_20251204-164726.svg
-rw-r--r-- 1 bamboo tbeng 1.1M Dec  4 17:05 tbsample_al3_thu_sq_sc_albert-3_20251204-164745
-rw-r--r-- 1 bamboo tbeng  36K Dec  4 17:05 tbsample_al3_thu_sq_sc_albert-3_20251204-164745.graph
-rw-r--r-- 1 bamboo tbeng 399K Dec  4 17:05 tbsample_al3_thu_sq_sc_albert-3_20251204-164745.svg
/tb/shared/tbricks/JIRA/TST-120864

[04/12 17:10:06] bamboo@albert-3 ~> ls -lh stacks
total 408K
-rw-r--r-- 1 bamboo tbeng 19K Dec  4 17:05 al3_thu_sq_sc.stack.20251204-164740.txt
-rw-r--r-- 1 bamboo tbeng 19K Dec  4 17:05 al3_thu_sq_sc.stack.20251204-164741.txt
-rw-r--r-- 1 bamboo tbeng 20K Dec  4 17:05 al3_thu_sq_sc.stack.20251204-164742.txt
-rw-r--r-- 1 bamboo tbeng 19K Dec  4 17:05 al3_thu_sq_sc.stack.20251204-164743.txt
-rw-r--r-- 1 bamboo tbeng 38K Dec  4 17:05 al3_thu_sq_sc.stack.20251204-164744.txt
-rw-r--r-- 1 bamboo tbeng 20K Dec  4 17:05 al3_thu_sq_sc.stack.20251204-164745.txt
-rw-r--r-- 1 bamboo tbeng 19K Dec  4 17:05 al3_thu_sq_sc.stack.20251204-164746.txt
-rw-r--r-- 1 bamboo tbeng 19K Dec  4 17:05 al3_thu_sq_sc.stack.20251204-164747.txt
-rw-r--r-- 1 bamboo tbeng 19K Dec  4 17:05 al3_thu_sq_sc.stack.20251204-164748.txt
-rw-r--r-- 1 bamboo tbeng 19K Dec  4 17:05 al3_thu_sq_sc.stack.20251204-164749.txt
-rw-r--r-- 1 bamboo tbeng 19K Dec  4 17:05 al3_thu_sq_sc.stack.20251204-164750.txt
-rw-r--r-- 1 bamboo tbeng 20K Dec  4 17:05 al3_thu_sq_sc.stack.20251204-164751.txt
-rw-r--r-- 1 bamboo tbeng 19K Dec  4 17:05 al3_thu_sq_sc.stack.20251204-164752.txt
-rw-r--r-- 1 bamboo tbeng 39K Dec  4 17:05 al3_thu_sq_sc.stack.20251204-164753.txt
-rw-r--r-- 1 bamboo tbeng 20K Dec  4 17:05 al3_thu_sq_sc.stack.20251204-164754.txt
-rw-r--r-- 1 bamboo tbeng 20K Dec  4 17:05 al3_thu_sq_sc.stack.20251204-164755.txt
-rw-r--r-- 1 bamboo tbeng 20K Dec  4 17:05 al3_thu_sq_sc.stack.20251204-164756.txt
-rw-r--r-- 1 bamboo tbeng 20K Dec  4 17:05 al3_thu_sq_sc.stack.20251204-164757.txt
/tb/shared/tbricks/JIRA/TST-120864{noformat}
Comment by Julia Solennikova [ 2025-12-05 ]
Results for 2.32:
 [https://bamboo.orcsoftware.com/browse/LOAD-SQ]
{noformat}
(Latency metric albert-2 2.32 a3ff7121d0ee Fri Dec  5 12:13:36 CET 2025)
===================================================================================================================================
                                                                    #      50%      80%      95%      99%    99.9%  >2x80%      MAX
===================================================================================================================================
protocol_out_order:order - protocol_in_order:order               6000     1 µs     2 µs     3 µs     3 µs     5 µs    0.2%     6 µs
  protocol_in_order:order - pe:handle_order_update_entry         6000     3 µs     5 µs    18 µs    30 µs    38 µs    8.0%    79 µs
    pe:handle_order_update_entry - pe:strategy_add_request       6000    14 µs    17 µs    19 µs    21 µs    24 µs    0.0%   384 µs
      pe:strategy_add_request - pe:handle_constructor_entry      6000    78 µs    84 µs    92 µs   137 µs   2.8 ms    0.8%   3.3 ms
        pe:handle_constructor_entry - pe:open_stream             6000    20 µs    22 µs    25 µs    27 µs    36 µs    0.0%    44 µs
          pe:open_stream - pe:open_stream                       30000    10 µs    67 µs    86 µs    91 µs   103 µs    0.0%   492 µs
            pe:open_stream - pe:order_add_request                6000    16 µs    18 µs    20 µs    23 µs    28 µs    0.0%    34 µs
              pe:order_add_request - tr_fw:received_order_add    6000     2 µs     2 µs     2 µs     3 µs     5 µs    0.5%     7 µs
                tr_fw:received_order_add - tr_fw:encode_request  6000    12 µs    13 µs    16 µs    25 µs    77 µs    0.9%   188 µs
                  tr_fw:encode_request - tr_fw:send_request      6000    14 µs    16 µs    19 µs    21 µs    25 µs    0.0%    35 µs
                    tr_fw:send_request - tr:send_request         6000     1 µs     1 µs     1 µs     1 µs     4 µs    0.7%     5 µs
-----------------------------------------------------------------------------------------------------------------------------------
Path: protocol_out_order:order - tr:send_request                 6000   282 µs   294 µs   311 µs   393 µs   3.1 ms    0.7%   3.5 ms
==================================================================================================================================={noformat}
Results with app pooling:
 [https://bamboo.orcsoftware.com/browse/LOAD-SQ0]
{noformat}
(Latency metric albert-2 app-pooling a3ff7121d0ee Fri Dec  5 12:30:38 CET 2025)
=============================================================================================================================================================
                                                                                            #      50%      80%      95%      99%     99.9%  >2x80%       MAX
=============================================================================================================================================================
protocol_out_order:order - protocol_in_order:order                                       6000     1 µs     2 µs     3 µs     3 µs     13 µs    0.5%     26 µs
  protocol_in_order:order - pe:handle_order_update_entry                                 6000     4 µs     5 µs    12 µs    28 µs     42 µs    5.7%    287 µs
    pe:handle_order_update_entry - pe:strategy_add_request                               6000    15 µs    17 µs    19 µs    21 µs     26 µs    0.0%     39 µs
      pe:strategy_add_request - pe:create_from_pool_entry                                6000     6 µs   193 µs   1.7 ms   9.1 ms   11.1 ms   10.7%   11.5 ms
        pe:create_from_pool_entry - pe:create_from_pool_success_exit                     5554     3 µs     4 µs     5 µs     6 µs      9 µs    0.2%     12 µs
          pe:create_from_pool_success_exit - pe:handle_execute_pool_modify_entry         5554     1 µs     2 µs     2 µs     2 µs      5 µs    0.3%      8 µs
            pe:handle_execute_pool_modify_entry - pe:handle_modify_request_entry         5554     2 µs     2 µs     2 µs     4 µs      6 µs    0.6%      8 µs
              pe:handle_modify_request_entry - pe:open_stream                            5554    75 µs    79 µs    84 µs    91 µs    124 µs    0.0%    138 µs
                pe:open_stream - pe:open_stream                                          5554    13 µs    15 µs    17 µs    19 µs     24 µs    0.0%     31 µs
                  pe:open_stream - pe:handle_modify_request_exit                         5554     8 µs     9 µs    12 µs    13 µs     18 µs    0.1%     22 µs
                    pe:handle_modify_request_exit - pe:handle_run_request_entry          5554     1 µs     1 µs     1 µs     1 µs      4 µs    0.6%      6 µs
                      pe:handle_run_request_entry - pe:order_add_request                 5554    11 µs    11 µs    12 µs    14 µs     17 µs    0.0%     26 µs
                        pe:order_add_request - protocol_out_order_entry:order            5554     3 µs     3 µs     4 µs     6 µs      8 µs    0.5%     10 µs
                          protocol_out_order_entry:order - protocol_in_order_entry:order 5554     2 µs     3 µs     3 µs     3 µs      6 µs    0.1%      7 µs
                            protocol_in_order_entry:order - tr_fw:received_order_add     5554     1 µs     2 µs     2 µs     4 µs      6 µs    0.5%      8 µs
                              tr_fw:received_order_add - tr_fw:encode_request            5554    12 µs    13 µs    16 µs    27 µs    239 µs    1.1%    479 µs
                                tr_fw:encode_request - tr_fw:send_request                5554    15 µs    17 µs    19 µs    21 µs     26 µs    0.0%     32 µs
                                  tr_fw:send_request - tr:send_request                   5554     1 µs     1 µs     1 µs     1 µs      4 µs    0.4%      5 µs
        pe:create_from_pool_entry - pe:handle_constructor_entry                           446   135 µs   164 µs   184 µs   218 µs    6.2 ms    0.2%    6.2 ms
          pe:handle_constructor_entry - pe:open_stream                                    446    20 µs    22 µs    25 µs    28 µs     32 µs    0.0%     32 µs
            pe:open_stream - pe:open_stream                                              2230    10 µs    26 µs    86 µs    93 µs     99 µs   20.0%    111 µs
              pe:open_stream - pe:order_add_request                                       446    16 µs    18 µs    20 µs    23 µs     33 µs    0.0%     33 µs
                pe:order_add_request - tr_fw:received_order_add                           446     2 µs     2 µs     2 µs     4 µs      5 µs    0.7%      5 µs
                  tr_fw:received_order_add - tr_fw:encode_request                         446    13 µs    15 µs    18 µs   115 µs    277 µs    2.0%    277 µs
                    tr_fw:encode_request - tr_fw:send_request                             446    15 µs    18 µs    20 µs    23 µs     27 µs    0.0%     27 µs
                      tr_fw:send_request - tr:send_request                                446     1 µs     1 µs     1 µs     4 µs     15 µs    2.9%     15 µs
-------------------------------------------------------------------------------------------------------------------------------------------------------------
Path: protocol_out_order:order - tr:send_request                                         6000   190 µs   374 µs   2.0 ms   9.4 ms   11.5 ms    8.6%   11.8 ms
============================================================================================================================================================={noformat}
App pooling resource:
{noformat}
<resource name="pool_config" type="application/x-pool-config+xml">
<apps>
    <app definition="3c68a749-cd6b-11e0-933b-245e0d1c06b7" size="5" user="5522d422-2f9e-11e5-bf70-ed884eb26bba" extend="2" purging="1">
        <parameter id="9b21a3fe-87dd-4008-a5a1-cefe070d4d67"/> <!-- Venue -->
        <parameter id="4862f28d-10ab-46f1-93c5-4c97e2048368"/> <!-- Instrument -->
        <parameter id="78d1ba99-e183-4531-addb-52c0bb460da5"/> <!-- MIC -->
    </app>
</apps>
</resource>
{noformat}

for 50 percentile results are better, but got higher outliers (more than 2 times)

================================================================================

[TST-123513] Verification of PRD-20950 (Spread quoter: introduce app pooling for child hedges) Created: 2025-11-14
Status:	Open
Project:	TST
Component/s:	Manual testing
Fix Version/s:	Tbricks 2.32

Type:	Test Plan	Priority:	Major
Reporter:	Stepan Edamenko	Assignee:	Roman Shevelev

Issue Links:
Tested
tests	PRD-20950	Spread quoter: introduce app pooling for child hedges	In Progress

================================================================================

## Project Context

- Detected project type:
 No files provided
- Number of changed files across all commits: 3
- Number of files changed in all commits: 3
- Changed files in all commits:
  production/strategy/spread_quoter/shared/SpreaderLeg.cpp, production/strategy/spread_quoter/shared/SpreaderLeg.h, production/strategy/spread_quoter/two_legged_spreader_delta/SpreaderLegTLSD.cpp

## Commit History Summary

This case involved 3 commits. Here's information about the commits:

Commit 0685a4b7925
Author: Anton El'kin (Anton.Elkin@itiviti.com)
Date: Fri Aug 15 16:29:15 2025 +0200
Subject: APP-47817: Use async creation for PO and MMO apps.

Commit 7f70cde009b
Author: Anton El'kin (Anton.Elkin@itiviti.com)
Date: Fri Aug 15 16:29:15 2025 +0200
Subject: APP-47817: Use async creation for PO and MMO apps.

Commit a2a0002dce3
Author: Anton El'kin (Anton.Elkin@itiviti.com)
Date: Fri Aug 15 16:29:15 2025 +0200
Subject: APP-47817: Use async creation for PO and MMO apps.


## Changes in all Commits:

    # Changes in 3 commits for this case
# First commit: 0685a4b7925931c9469b6029031c67f9cd4bed0f
# Last commit: a2a0002dce3aaa83e1ca196c90fb1170b78c512a
# Total files changed: 3

# File: production/strategy/spread_quoter/shared/SpreaderLeg.cpp
diff --git a/production/strategy/spread_quoter/shared/SpreaderLeg.cpp b/production/strategy/spread_quoter/shared/SpreaderLeg.cpp
index c38d52c38aa..87d862dc1cc 100644
--- a/production/strategy/spread_quoter/shared/SpreaderLeg.cpp
+++ b/production/strategy/spread_quoter/shared/SpreaderLeg.cpp
@@ -744,7 +744,7 @@ void SpreaderLeg::OrderUpdated(const tbricks::Order::Update& update, bool explic
 
             if (it->second.IsHedgeOrder())
             {
-                DeletedImmediateHedgeOrder(it->second);
+                DeletedInitialHedgeOrder(it->second);
             }
             else if (it->second.IsHitOrder())
             {
@@ -776,7 +776,7 @@ void SpreaderLeg::OrderUpdated(const tbricks::Order::Update& update, bool explic
                         it->second.m_order.GetStatusText(statusText);
                     }
                     String error = "Immediate order in " + GetInstrumentDescription().ToString() + " has failed state: "  + statusText;
-                    m_handler.HandleImmediateHedgeFailure(*this, error);
+                    m_handler.HandleInitialHedgeFailure(*this, error);
                     // Note: No delete request here to avoid eternal loops, and no creation of paused OS (this is only done once the order is deleted)
                 }
                 else if (state != TransactionState::PENDING && !it->second.IsTimeToLiveActive() && !it->second.m_nativelyImmediate)
@@ -958,7 +958,7 @@ bool SpreaderLeg::HedgeTrade(const SpreaderLeg &quoteLeg,
         {
             SendCompositeOrder(hedgeOrderVolume, m_minHedgeSweetener.GetInt(), extraData, createPaused, true);
         }
-        else if (createPaused || m_skipInitialIOC)
+        else if (createPaused || m_skipInitialHedge)
         {
             SendHedgeOrderStrategy(GetSide(),
                                 hedgeOrderVolume,
@@ -1336,8 +1336,8 @@ void SpreaderLeg::SendCompositeOrder(const tbricks::Volume& volume,
         {
             parameters.SetParameter(strategy_parameters::BypassSoftLimits(), m_bypassSoftLimits);
         }
-
-        Strategy::RequestResult createRequest = Strategy::SendCreateRequest(options, parameters, *this);
+   
+                Strategy::RequestResult createRequest = Strategy::SendCreateRequest(options, parameters, *this);
         m_strategyManager.Subscribe(this, createRequest.GetStrategyIdentifier());
 
         m_hedgeCreateRequests[createRequest.GetRequestIdentifier()] = createRequest.GetStrategyIdentifier();
@@ -1577,7 +1577,7 @@ void SpreaderLeg::SendHedgeOrderStrategy(const tbricks::Side& side,
         options.SetStateRunning();
 
     Strategy::RequestResult createRequest =
-            Strategy::SendCreateRequest(options,
+            Strategy::SendAsyncCreateRequest(options,
                                         GetHedgeOrderStrategyParameters(options.GetType(),
                                                                         side,
                                                                         volume,
@@ -1586,15 +1586,9 @@ void SpreaderLeg::SendHedgeOrderStrategy(const tbricks::Side& side,
                                                                         orderType),
                                         *this);
 
-    m_strategyManager.Subscribe(this, createRequest.GetStrategyIdentifier());
-    m_hedgeCreateRequests[createRequest.GetRequestIdentifier()] = createRequest.GetStrategyIdentifier();
-    m_hedges[createRequest.GetStrategyIdentifier()] = HedgeStrategy(createRequest.GetStrategyIdentifier(), paused);
-    TBSTATUS("Sent " << (paused ? "paused " : "") << " hedge: " << side << " " << volume << "@" << price);
+    TBSTATUS("Sent " << (paused ? "paused " : "") << " hedge: " << side << " " << volume << "@" << price << " request id: " << createRequest.GetRequestIdentifier());
 
-    if ((orderType == HEDGE_ORDER) && !paused)
-    {
-        StartHedgeTimer(createRequest.GetStrategyIdentifier());
-    }
+    m_hedgeRequests.emplace(createRequest.GetRequestIdentifier(), RequestData(paused, orderType));
 }
 
 void SpreaderLeg::CreatePausedHedgeOrderStrategy()
@@ -1776,7 +1770,7 @@ void SpreaderLeg::HandleRequestReply(const tbricks::Identifier& request_id,
                     }
                     else 
                     {
-                        DeletedImmediateHedgeOrder(minimalOrder, error);
+                        DeletedInitialHedgeOrder(minimalOrder, error);
                     }
 
                     break;
@@ -1787,6 +1781,40 @@ void SpreaderLeg::HandleRequestReply(const tbricks::Identifier& request_id,
     TBDEBUG("HandleRequestReply done");
 }
 
+void SpreaderLeg::HandleStrategyRequestReply(const StrategyIdentifier & strategyId, 
+                                             const Identifier & id,
+                                             Status status,
+                                             const String & status_text)
+{
+    TBSTATUS(__func__ << " request: " << id << " strategy id: " << strategyId << " status: " << status << " text: " << status_text);
+    if (auto it = m_hedgeRequests.find(id); it != m_hedgeRequests.end())
+    {
+        // Handle hedge request
+        const auto& requestData = it->second;
+
+        m_strategyManager.Subscribe(this, strategyId);
+
+        m_hedgeCreateRequests[id] = strategyId;
+
+        auto& hedge = m_hedges[strategyId];
+        hedge = HedgeStrategy(strategyId, requestData.paused);
+
+        if (requestData.basketVolume.has_value())
+        {
+            hedge.SetBasketVolume(requestData.basketVolume.value());
+        }
+
+        if ((requestData.orderType == HEDGE_ORDER) && !requestData.paused)
+        {
+            StartHedgeTimer(strategyId);
+        }
+
+        m_hedgeRequests.erase(it);
+    }
+
+    HandleRequestReply(id, status, status_text);
+}
+
 void SpreaderLeg::HandleOrderMinionUpdate(const OrderMinionUpdate& update)
 {
     TBDEBUG("HandleOrderMinionUpdate");
@@ -1797,7 +1825,7 @@ void SpreaderLeg::HandleOrderMinionUpdate(const OrderMinionUpdate& update)
         if (it != m_orderMinionHedgeRequests.end())
         {
             const OrderMinionRequest& request = it->second.GetOrderMinionRequest();
-            CompletedImmediateHedge(update.GetTotalVolume(),
+            CompletedInitialHedge(update.GetTotalVolume(),
                                     update.GetFilledVolume(),
                                     request.GetTargetPrice(),
                                     request.GetPrice(),
@@ -1838,7 +1866,7 @@ void SpreaderLeg::HandleOrderMinionUpdate(const OrderMinionUpdate& update)
     }
 }
 
-void SpreaderLeg::DeletedImmediateHedgeOrder(const MinimalOrder& hedgeOrder, const String & error)
+void SpreaderLeg::DeletedInitialHedgeOrder(const MinimalOrder& hedgeOrder, const String & error)
 {
     TBDEBUG("Immediate hedge order is deleted");
 
@@ -1861,7 +1889,7 @@ void SpreaderLeg::DeletedImmediateHedgeOrder(const MinimalOrder& hedgeOrder, con
         failed = true;
         hedgeOrder.m_order.GetStatusText(statusText);
     }
-    CompletedImmediateHedge(targetVolume,
+    CompletedInitialHedge(targetVolume,
                             filledVolume,
                             hedgeOrder.m_targetPrice,
                             hedgeOrder.m_price,
@@ -1871,7 +1899,7 @@ void SpreaderLeg::DeletedImmediateHedgeOrder(const MinimalOrder& hedgeOrder, con
                             hedgeOrder.m_order.GetIdentifier().GetUuid());
 }
 
-void SpreaderLeg::CompletedImmediateHedge(const tbricks::Volume& targetVolume,
+void SpreaderLeg::CompletedInitialHedge(const tbricks::Volume& targetVolume,
                                           const tbricks::Volume& filledVolume,
                                           const tbricks::Price& targetPrice,
                                           const tbricks::Price& price,
@@ -1899,7 +1927,7 @@ void SpreaderLeg::CompletedImmediateHedge(const tbricks::Volume& targetVolume,
             {
                 TBNOTICE("Immediate hedge order has failed. SQ will stop and create paused hedge orders: " << errorString);
 
-                m_handler.HandleImmediateHedgeFailure(*this, errorString);
+                m_handler.HandleInitialHedgeFailure(*this, errorString);
                 createPausedPlusOrderHedge = true;
             }
 
@@ -1920,7 +1948,7 @@ void SpreaderLeg::CompletedImmediateHedge(const tbricks::Volume& targetVolume,
         }
     }    
 
-    m_handler.HandleImmediateHedgeStatisticsUpdate(*this, id, targetVolume, tmpFilledVolume, targetPrice);
+    m_handler.HandleInitialHedgeStatisticsUpdate(*this, id, targetVolume, tmpFilledVolume, targetPrice);
 }
 
 void SpreaderLeg::CompletedHitOrder(const tbricks::Volume & filledVolume,
@@ -2550,7 +2578,7 @@ void SpreaderLeg::SetDefaultValues()
 
 bool SpreaderLeg::HasHedges() const
 {
-    return !m_hedges.empty() || !m_immediateOrders.empty() || !m_orderMinionHedgeRequests.empty();
+    return HasHedgeOrders() || !m_immediateOrders.empty() || !m_orderMinionHedgeRequests.empty();
 }
 
 bool SpreaderLeg::HasTradedAtLeastTotalVolume() const

# File: production/strategy/spread_quoter/shared/SpreaderLeg.h
diff --git a/production/strategy/spread_quoter/shared/SpreaderLeg.h b/production/strategy/spread_quoter/shared/SpreaderLeg.h
index f19fa205c7b..6c43472beca 100644
--- a/production/strategy/spread_quoter/shared/SpreaderLeg.h
+++ b/production/strategy/spread_quoter/shared/SpreaderLeg.h
@@ -151,13 +151,13 @@ public:
         virtual void HandleHedgeStrategyFailedState(SpreaderLeg & leg, const tbricks::String & error) = 0;
 
         // Reporting unsuccessful hedging
-        virtual void HandleImmediateHedgeFailure(SpreaderLeg & leg, const tbricks::String & error) = 0;
+        virtual void HandleInitialHedgeFailure(SpreaderLeg & leg, const tbricks::String & error) = 0;
         virtual void HandleTrulyMissedHedge(SpreaderLeg & leg) = 0;
-        virtual void HandleImmediateHedgeStatisticsUpdate(SpreaderLeg & leg,
-                                                          const tbricks::Uuid & id,
-                                                          const tbricks::Volume & targetVolume,
-                                                          const tbricks::Volume & resultingVolume,
-                                                          const tbricks::Price & targetPrice) = 0;
+        virtual void HandleInitialHedgeStatisticsUpdate(SpreaderLeg & leg,
+                                                        const tbricks::Uuid & id,
+                                                        const tbricks::Volume & targetVolume,
+                                                        const tbricks::Volume & resultingVolume,
+                                                        const tbricks::Price & targetPrice) = 0;
 
         virtual FXHandler& GetFXHandler() = 0;
 
@@ -368,6 +368,11 @@ public:
                                     tbricks::Status status,
                                     const tbricks::String & text) override;
 
+    void HandleStrategyRequestReply(const StrategyIdentifier & strategyId,
+                                    const Identifier & id,
+                                    Status status,
+                                    const String & status_text) override;
+
     // ITimer
     virtual void HandleTimerEvent(tbricks::Timer & timer) override;
 
@@ -744,13 +749,13 @@ protected:
         bool                    m_pauseRequestWasReceived { false };
         tbricks::Volume         m_basketVolume { 0.0 };
     };
-    typedef std::unordered_map<tbricks::StrategyIdentifier, HedgeStrategy, TbricksHash> Strategies;
+    using Strategies = std::unordered_map<tbricks::StrategyIdentifier, HedgeStrategy, TbricksHash>;
     Strategies m_hedges;
 
     Strategies m_uncontrolledHedges;
 
     // The requests made
-    typedef tbricks::Hash<tbricks::Identifier, tbricks::StrategyIdentifier> StrategyRequests;
+    using StrategyRequests = tbricks::Hash<tbricks::Identifier, tbricks::StrategyIdentifier>;
     StrategyRequests m_hedgeCreateRequests;
 
     // For immediate SOR stuff
@@ -788,6 +793,18 @@ protected:
     // Minimal data of the plain immediate orders
     enum MinimalOrderType{HEDGE_ORDER, BALANCE_ORDER, HIT_MARKET_ORDER, PAUSED_ORDER, CONSOLIDATING_ORDER};
 
+    struct RequestData
+    {
+        RequestData(bool paused, MinimalOrderType orderType) : paused(paused), orderType(orderType) {}
+        RequestData(bool paused, MinimalOrderType orderType, const tbricks::Volume& basketVolume) : paused(paused), orderType(orderType), basketVolume(basketVolume) {}
+
+        bool paused;
+        MinimalOrderType orderType;
+        std::optional<tbricks::Volume> basketVolume;
+    };
+
+    std::unordered_map<tbricks::Identifier, RequestData> m_hedgeRequests;
+
     class MinimalOrder
     {
     public:
@@ -863,6 +880,11 @@ protected:
         mp_orderMinionController->Cancel(OrderMinionCancelRequest{requestId});
     }
 
+    bool HasHedgeOrders() const
+    {
+        return !m_hedges.empty() || !m_hedgeRequests.empty();
+    }
+
     // Average calculations
     tbricks::Double m_priceTimesVolumeSum;
     tbricks::Double m_invested;
@@ -925,15 +947,15 @@ protected:
                                         const tbricks::ExtraData & extraData,
                                         const MinimalOrderType orderType);
 
-    virtual void DeletedImmediateHedgeOrder(const MinimalOrder & hedgeOrder, const String & error = {});
-    virtual void CompletedImmediateHedge(const tbricks::Volume & targetVolume,
-                                         const tbricks::Volume & filledVolume,
-                                         const tbricks::Price & targetPrice,
-                                         const tbricks::Price & price,
-                                         const tbricks::ExtraData & extraData,
-                                         bool initialOrderFailed,
-                                         const tbricks::String & errorString,
-                                         const tbricks::Uuid & id);
+    virtual void DeletedInitialHedgeOrder(const MinimalOrder & hedgeOrder, const String & error = {});
+    virtual void CompletedInitialHedge(const tbricks::Volume & targetVolume,
+                                       const tbricks::Volume & filledVolume,
+                                       const tbricks::Price & targetPrice,
+                                       const tbricks::Price & price,
+                                       const tbricks::ExtraData & extraData,
+                                       bool initialOrderFailed,
+                                       const tbricks::String & errorString,
+                                       const tbricks::Uuid & id);
 
     virtual void CompletedHitOrder(const tbricks::Volume & filledVolume,
                                    const tbricks::Price & price,

# File: production/strategy/spread_quoter/two_legged_spreader_delta/SpreaderLegTLSD.cpp
diff --git a/production/strategy/spread_quoter/two_legged_spreader_delta/SpreaderLegTLSD.cpp b/production/strategy/spread_quoter/two_legged_spreader_delta/SpreaderLegTLSD.cpp
index 1345b4005b5..30d4f014b46 100644
--- a/production/strategy/spread_quoter/two_legged_spreader_delta/SpreaderLegTLSD.cpp
+++ b/production/strategy/spread_quoter/two_legged_spreader_delta/SpreaderLegTLSD.cpp
@@ -210,7 +210,7 @@ bool SpreaderLegTLSD::HedgeTrade(const SpreaderLeg &quoteLeg,
 void SpreaderLegTLSD::RevertFill(const Price& price, const Volume& volume)
 {
     // Can't send a new revert order if there is another revert order
-    if (!m_hedges.empty())
+    if (HasHedgeOrders())
     {
         return;
     }
@@ -298,7 +298,7 @@ void SpreaderLegTLSD::HandleMainOrderDeleted(FastOrderHandler & fastOrder)
     CheckIfDone();
 }
 
-void SpreaderLegTLSD::CompletedImmediateHedge(const Volume & targetVolume,
+void SpreaderLegTLSD::CompletedInitialHedge(const Volume & targetVolume,
                                  const Volume & filledVolume,
                                  const Price & targetPrice,
                                  const Price & price,
@@ -308,7 +308,7 @@ void SpreaderLegTLSD::CompletedImmediateHedge(const Volume & targetVolume,
                                  const Uuid & id)
 {
     Volume tmpFilledVolume(filledVolume.Empty() ? Volume(0) : filledVolume);
-    m_handler.HandleImmediateHedgeStatisticsUpdate(*this, id, targetVolume, tmpFilledVolume, targetPrice);
+    m_handler.HandleInitialHedgeStatisticsUpdate(*this, id, targetVolume, tmpFilledVolume, targetPrice);
 }
 
 void SpreaderLegTLSD::SendConsolidatingOrders()

