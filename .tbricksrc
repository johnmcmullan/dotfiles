# -*- mode: sh -*-

function prompt()
{
    git status > /dev/null 2>&1
    if [ $? -eq 0 ] ; then
	BRANCH=`git rev-parse --abbrev-ref HEAD`
	BRANCH_BASENAME=`basename $BRANCH`
	echo -e '\033]2;'${BRANCH}'\007'
    else
	printf "\033]0;%s@%s:%s\007" "${USER}" "${HOSTNAME%%.*}" "${PWD/#$HOME/~}"
    fi
}

function tempo_log()
{
    LOG=~/.tempo.log
    JIRA="NONE"
    git status > /dev/null 2>&1
    if [ $? -eq 0 ] ; then
        JIRA=`/bin/git rev-parse --abbrev-ref HEAD | cut -d\/ -f2 | cut -d\- -f1-2`
    fi
    TIMESTAMP=`date '+%Y%m%d %H:%M:%S'`
    HOSTNAME=`hostname -s`
    echo "${TIMESTAMP}|${HOSTNAME}|${JIRA}|${1}" >> $LOG
}

function make()
{
    tempo_log "make"
    /bin/make "$@"
}

function makedb()
{
    DBPATH=${1:-.}
    DBFILE=$DBPATH/.ccls
    cat > $DBFILE <<EOF
${LLVM}/bin/clang++
%h -x
%h c++-header
-isystem$(realpath $SDK)/include64
-I$(realpath $TB_APPS)
-DLINUX
-DLINUX64
-DU_USING_ICU_NAMESPACE=0
-DLUA_LIB=\"tbricks_lua\"
-DLUAJIT_LIB=\"luajit\"
-DTB_USE_RCU
-DURCU_INLINE_SMALL_FUNCTIONS
-DFMT_SHARED
-DNDEBUG
-D_POSIX_PTHREAD_SEMANTICS
-fPIC
-D_GNU_SOURCE
-D_GLIBCXX_USE_CXX11_ABI=0
-m64
--gcc-toolchain=$GCC_SUITE
-flto=full
-fclang-abi-compat=6.0
-std=gnu++17
-D_GLIBCXX_DEPRECATED=
-pipe
-pthread
-march=core2
-mtune=corei7
-Qunused-arguments
EOF
    rm -rf $DBPATH/.ccls-cache

    for MAKEFILE in `find $DBPATH -name GNUmakefile` ; do
        grep FLAGS $MAKEFILE | egrep -v '^#'| awk '{printf("%s\n", $3)}'
        grep HEADERS $MAKEFILE | egrep -v '^#' | awk '{printf("-I%s\n", $3)}'
    done | sort -u >> $DBFILE
}

function code-tidy()
{
    ${LLVM}/share/clang/run-clang-tidy.py -j4 -fix  -style file -header-filter='^((?!(.*\/shared\/.*)).)*$' -clang-tidy-binary ${LLVM}/bin/clang-tidy -clang-apply-replacements-binary ${LLVM}/bin/clang-apply-replacements
}

function setsdk()
{
    VERSION=$1
    SELECTED_COUNT=`ls -ald $TBRICKS/*sdk-*$VERSION* | wc -l`
    if [ -z "$SELECTED_COUNT" ]; then
        echo "No sdk version: $VERSION"
        return
    elif [ $SELECTED_COUNT != "1" ]; then
        echo "$VERSION is ambiguous when selecting sdk"
        return
    else
        export SDK=`eval echo "$TBRICKS/*sdk-$VERSION*"`
        if [ -L $TBRICKS/sdk ] ; then
            rm -f $TBRICKS/sdk
            ln -s $SDK $TBRICKS/sdk
            export SDK=$TBRICKS/sdk
        fi
#        rm -rf $TB_APPS/.ccls-cache
#        makedb $TB_APPS
        recompute_manpath
        echo "SDK is `realpath $SDK`"
    fi
}

function create_user()
{
    SYSTEM=$1
    USER=`id -un`
    tbuser create ${USER} ${SYSTEM}
    tbuser set roles=Unrestricted ${USER} ${SYSTEM}
    tbuser set password= ${USER} ${SYSTEM}
}

function bearapp()
{
    BEAR=`which bear`
    NPROC=`nproc`
    touch .ccls
    make clean
    rm -rf .ccls-cache
    name $BEAR make -j$NPROC RECURSIVE=YES
}

function recompute_manpath()
{
    MANPATH=/usr/share/man:/usr/local/share/man:/usr/share/locale/man:
    MANPATH+=$LLVM/share/man:$GCC_SUITE/share/man:
    MANPATH+=$ADMIN_ROOT/doc/man:$SDK/doc/man:$SDK/doc/libraries/strategy/man
    export MANPATH
}

export PROMPT_COMMAND=prompt
export PS1='\[\e[1;32m\]\h:\W\[\e[m\]$ '

LOCAL_TBSH=$HOME/.local_tbsh
if [ -f $LOCAL_TBSH ] ; then
    source $LOCAL_TBSH
else
    export TBRICKS="/opt/tbricks"
    export TBRICKS_ADMIN_CENTER=dev_jmm_admin_sys
    export TBRICKS_ROOT=$TBRICKS
    export ADMIN_ROOT="$TBRICKS/admin"
fi

# clang++
LLVM="/opt/llvm-10"
# g++
GCC_SUITE="/opt/gcc-8.2.0"
export GCC_SUITE LLVM

recompute_manpath

if [ -f ${ADMIN_ROOT}/etc/bash/.tbricks_completion.bash ] ; then
    source $ADMIN_ROOT/etc/bash/.tbricks_completion.bash
fi

export TB_APPS=$HOME/work/apps
export MK_SRCROOT=$HOME/work/apps
export MAKE=gmake
: "${SDK:=$TBRICKS/sdk}"
export SDK
export CLANG_TIDY_CHECKS='-*,performance-no-automatic-move,performance-move-const-arg,performance-inefficient-vector-operation,bugprone-unused-raii,bugprone-use-after-move,bugprone-bool-pointer-implicit-conversion,performance-implicit-conversion-in-loop,readability-implicit-bool-conversion,bugprone-misplaced-widening-cast,bugprone-move-forwarding-reference,bugprone-bool-pointer-implicit-conversion,bugprone-string-constructor,bugprone-string-integer-assignment'
 
export CLANG_TIDY_ARGS="--quiet --config=\"{Checks: '*', CheckOptions: [{key: readability-implicit-bool-conversion.AllowIntegerConditions, value: 1}, {key: readability-implicit-bool-conversion.AllowPointerConditions, value: 1}, {key: performance-move-const-arg.CheckTriviallyCopyableMove, value: 0}]}\""
